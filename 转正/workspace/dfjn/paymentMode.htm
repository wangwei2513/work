<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>paymentMode</title>
    <style>
        .gray {
            -webkit-filter: grayscale(100%);
            -moz-filter: grayscale(100%);
            -ms-filter: grayscale(100%);
            -o-filter: grayscale(100%);
            filter: grayscale(100%);
            filter: gray;
        }
    </style>

    <script language="javascript" src="js/ratings.js"></script>
    <script language="javascript" src="http://webclient.homed.me/application/commonJS/homedconfig.js"></script>
    <script src="js/common.js"></script>
    <script src="js/ajax.js"></script>
    <script src="js/keyevent.js"></script>
    <script>
        initPage(window);
        window.moveTo(0, 0);
        window.resizeTo(1280, 720);
        var isAdvanceFlag = false;
        var navString = navigator.userAgent;


        //判断是否是advance版本,或是chrome版本
        if (navString.toLowerCase().indexOf("advanced") >= 0 || navString.toLowerCase().indexOf("chrome") > 0) {
            isAdvanceFlag = true;
        }
        if (navString.toLowerCase().indexOf("chrome") > 0) {}
        var navigatorFlag = (navigator.appName.indexOf("iPanel") != -1) ? "iPanel" : "other";
        var playParam = {},
            retrunFlag = 0;
        var ajaxObj = {
            requestAbort: function() {}
        };
        var da_id = navigator.appName.indexOf("iPanel") != -1 ? iPanel.eventFrame.da_id : testDaId;
        var deviceid = navigator.appName.indexOf("iPanel") != -1 ? (iPanel.eventFrame.device_id ? iPanel.eventFrame.device_id : 9999) : 9999;
        var homed_id = navigator.appName.indexOf("iPanel") != -1 ? iPanel.eventFrame.homed_id : "1234";
        var access_token = navigator.appName.indexOf("iPanel") != -1 ? iPanel.eventFrame.access_token : testAccessToken;
        var closeWidgetKeyValue = 0; //记录具体按键关闭当前widget时，需要留到mainFrame的键值
        var payPos = 0; //支付方式 0 银联支付 1 微信支付 2 招商银行 3 大连银行
        var prCodesContent = ""; //二维码content
        var prCodesBgColor = "#f4f1f1"; //二维码的背景色
        var prCodesColor = "black"; //二维码的前景色
        var codeUrl = ""; //二维码地址
        var flag = ""; //0微信支付 1支付宝支付
        var orderId = "";
        var type = "";
        var focusArea = 0;
        var isVip = false;

        var ajaxReqObj = {
            payAjaxObj: {
                requestAbort: function() {}
            }
        };
        var keyFlag = true;
        document.onkeydown = eventHandler(event);

        function eventHandler(event) {
            var e = e || event;
            var keycode = e.keyCode || e.which || e.charCode;

            // var keycode = eventObj.code;
            switch (keycode) {
                case 1:
                case 38: //up

                    // case "KEY_UP": //up
                    changeUDFocus(-1);
                    return returnFalseFlag;
                    break;
                case 2:
                case 40: //down

                    // case "KEY_DOWN": //down
                    changeUDFocus(1);
                    return returnFalseFlag;
                    break;
                case 3:
                case 37: //left

                    // case "KEY_LEFT": //left
                    return returnFalseFlag;
                    break;
                case 4:
                case 39: //right

                    // case "KEY_RIGHT": //right
                    return returnFalseFlag;
                    break;
                case 13:

                    // case "KEY_SELECT": //enter
                    doSelect();
                    return returnFalseFlag;
                    break;
                case 8:

                    // case "KEY_BACK":
                    // case "KEY_BACK":
                    // hideWidget();
                    return returnFalseFlag;
                    break;
                case "EIS_SOCKET_BOUGHT_MESSAGE":
                    var p2 = eventObj.args.modifiers;
                    var boughtObj = getGlobalVar("boughtObj");
                    collect(id, boughtObj.programType, boughtObj.parentId, boughtObj.parentType, 104);
                    iDebug("yanch EIS_SOCKET_BOUGHT_MESSAGE p2 = " + p2)
                    if (p2 == 1) {
                        setTimeout(function() {
                            if (navigatorFlag == "iPanel") {
                                iPanel.mainFrame.showOrderPop();
                            } else {
                                top.showOrderPop();
                            }
                            keyFlag = true;
                        }, 500);
                    }
                    return returnFalseFlag;
                    break;
                case "KEY_HOMEPAGE":
                    iPanel.eventFrame.needToPortal = 0;
                    gotoPortal();
                    closePage();
                    return returnFalseFlag;
                    break;
                default:
                    return commonHandler(eventObj);
                    break;
            }
            if (isAdvanceFlag) {
                eventObj.args.type = eventObj.args.type ? true : false;
            }
            return eventObj.args.type;
        }

        function hideWidget() {
            var paymenMode = iPanel.pageWidgets.getByName("paymenMode");
            if (paymenMode != null) {
                paymenMode.minimize();
            }
        }
        var DEBUG = 0; //是否调试状态 ; 0表示真实数据，1表示假数据
        var orderId = 0; //订单号
        var codeUrlArr = {
            "4": "",
            "5": ""
        };
        if (navigatorFlag != "iPanel") {
            window.onload = init;
        }
        /*var ws = window.iPanel?iPanel.evnetFrame.socketObj.ws:null
        if(ws){
        	iDebug("yanch ws here")
        	ws.onmessage = function(eve){
        		var getData = eval("("+eve.data.split("|")[1]+")");
        		if(getData.message_type === 10702 && getData.message_value ===1){
        			if(getData.result === 1){
        				setTimeout(function(){
        						if(navigatorFlag=="iPanel"){
        							iPanel.mainFrame.showOrderPop(1);
        						}else{
        							top.showOrderPop(1);
        						}
        						keyFlag = true;					
        					},500);
        				}
        			}
        		}
        	}*/
        function init(_paramObj) {
            if (navigatorFlag == "iPanel") {
                orderId = _paramObj.orderId;
                $("orderName").innerHTML = iPanel.mainFrame.roll_name;
                $("orderMoney").innerHTML = "金额：" + iPanel.mainFrame.targetPrice / 100 + "元";
            } else {
                orderId = getParam("orderId");
                $("orderName").innerHTML = top.targetName;
                $("orderMoney").innerHTML = "金额：" + top.targetPrice + "元";
            }
            getAccountBalance();
            changePayTypeFocus(0);
        }
        /*获取url中携带参数*/
        function getParam(_type, _url) {
            var url = _url || window.location.href;
            if (new RegExp(".*\\b" + _type + "\\b(\\s*=([^&]+)).*", "gi").test(url)) {
                return RegExp.$2;
            } else {
                return null;
            }
        }

        function getAccountBalance() {
            var balance = 0;
            if (navigatorFlag == "iPanel") {
                balance = iPanel.mainFrame.balance;
            } else {
                balance = top.balance;
            }
            $("balance").innerHTML = "剩余金额：￥" + balance / 100;
        }

        function payMoney(_orderId, _paymentType) {
            var payUrl = [slaveAddr + "/feemanager/ordermanager/pay", "test/pay_" + payPos + ".js"][DEBUG];;
            iDebug("[play.php]---payMoney()---payUrl=" + payUrl + '{"accesstoken":"' + access_token + '","orderid":' + _orderId + ',"paymentmode":' + _paymentType + ',"paymentinfo":{"sign":"","tradetype":"NATIVE","spbillcreateipstring":""}}');
            ajaxReqObj.payAjaxObj.requestAbort();
            ajaxReqObj.payAjaxObj = new AJAX_OBJ(payUrl, function(_xmlResponse, _res) {
                var res = eval("(" + _xmlResponse.responseText + ")");
                var data = res;
                if (data.ret == 0) {
                    if (_paymentType == 1) { //余额支付
                        $("payTips").src = "img/paysuc.png";
                        $("payText").innerHTML = "恭喜您，支付成功";
                        setTimeout(function() {
                            if (navigatorFlag == "iPanel") {
                                iPanel.mainFrame.showOrderPop(1);
                            } else {
                                top.showOrderPop(1);
                            }
                            keyFlag = true;
                        }, 500);
                    } else {
                        $("div1").style.visibility = "visible";
                        $("div2").style.visibility = "hidden";
                        codeUrl = data.code_url;
                        codeUrlArr[_paymentType + ""] = codeUrl;
                        iDebug("[play.php]---payMoney()---codeUrl=" + codeUrlArr[_paymentType + ""]);
                        initErweima(_paymentType);
                    }


                } else {
                    if (_paymentType == 1) { //余额支付
                        $("payTips").src = "img/payfail.png";
                        $("payText").innerHTML = "对不起，支付失败";
                    } else {
                        $("div1").style.visibility = "hidden";
                        $("div2").style.visibility = "visible";
                        $("payTips").src = "images/global_tm.gif";
                        $("payText").innerHTML = "此渠道暂不支持支付";
                    }
                }
            }, function(_xmlResponse) {
                if (_paymentType == 1) { //余额支付
                    $("payTips").src = "img/payfail.png";
                    $("payText").innerHTML = "对不起，支付失败";
                }

            });
            ajaxReqObj.payAjaxObj.urlParameters = '{"accesstoken":"' + access_token + '","orderid":' + _orderId + ',"paymentmode":' + _paymentType + ',"paymentinfo":{"sign":"","tradetype":"NATIVE","spbillcreateipstring":""}}';
            ajaxReqObj.payAjaxObj.requestData("POST");
            iDebug("[play.php]---payMoney()---payAjaxObj.urlParameters=" + ajaxReqObj.payAjaxObj.urlParameters + new Date());
        }

        function changeUDFocus(_num) {
            changePayTypeFocus(_num);
        }

        function changePayTypeFocus(_num) {
            $("rechargeType" + payPos).style.backgroundColor = "#ffffff";
            $("arrow_" + payPos).style.visibility = "hidden";
            payPos = (payPos + _num + 4) % 4;
            $("rechargeType" + payPos).style.backgroundColor = "#ffb400";
            $("arrow_" + payPos).style.visibility = "visible";
            //支付方式，取值1：boss账户（CA卡）【默认】，2：银行卡，3：银联，4：微信，5：支付宝。
            if (payPos == 0) payType = 4;
            else if (payPos == 1) payType = 5;
            else if (payPos == 2) payType = 3;
            else if (payPos == 3) payType = 1;
            if (payType == 3) { //银联购买只需下单，应用封装pay需要的信息生成二维码，手机端去处理pay
                $("div1").style.visibility = "visible";
                $("div2").style.visibility = "hidden";
                codeUrl = '{"function":"pay","accesstoken":"' + access_token + '","orderid":' + orderId + ',"paymentmode":' + payType + ',"paymentinfo":{"sign":"","tradetype":"NATIVE","spbillcreateipstring":""}}';
                initErweima(payType);
            } else if (payType == 1) { //余额支付
                ajaxReqObj.payAjaxObj.requestAbort();
                $("div1").style.visibility = "hidden";
                $("div2").style.visibility = "visible";
                $("payTips").src = "img/pay.png";
                $("payText").innerHTML = '您正在使用余额支付，<br/>确定继续支付请按"确定"键';
            } else {
                $("div1").style.visibility = "visible";
                $("div2").style.visibility = "hidden";
                iDebug("[play.php]---changePayTypeFocus()---codeUrlArr[payType]=" + codeUrlArr[payType + ""]);
                if (codeUrlArr[payType + ""] != "") {
                    codeUrl = codeUrlArr[payType + ""];
                    initErweima(payType);
                } else {
                    payMoney(orderId, payType);
                }
            }
        }


        function initErweima(_paymentType) {
            iDebug("initErweima---codeUrl = " + codeUrl);
            if (navigatorFlag == "iPanel") {
                if (_paymentType == 3) { //银联支付
                    //$("erweima").src = codeUrl;//德州版本的特殊处理
                    $("erweima").src = "qr://content=" + encodeURIComponent(codeUrl) + "&bgcolor=" + prCodesBgColor + "&color=" + prCodesColor;
                    iDebug("yanch paymentMode initErweima src=" + $("erweima").src)
                } else { //：银联，4：微信，5：支付宝。
                    $("erweima").src = "qr://content=" + codeUrl + "&bgcolor=" + prCodesBgColor + "&color=" + prCodesColor;
                }
            } else {
                $("erweima").src = "img/erweima.png";
            }
            if (_paymentType == 4) {
                $("erweimaText").innerHTML = '使用<img src="img/icon_01.png" width="28" height="28" style="vertical-align:text-bottom;"/>微信扫描二维码进行支付';
            } else if (_paymentType == 5) {
                $("erweimaText").innerHTML = '使用<img src="img/icon_02.png" width="28" height="28" style="vertical-align:text-bottom;"/>支付宝扫描二维码进行支付';
            } else if (_paymentType == 3) {
                $("erweimaText").innerHTML = '使用<img src="img/flag1.png" width="28" height="28" style="vertical-align:text-bottom;"/>家峪智能APP扫描二维码进行支付';
            }

        }

        function doSelect() {
            if (payType == 1) {
                $("payTips").src = "img/paying.png";
                $("payText").innerHTML = "正在支付中……";
                keyFlag = false;
                payMoney(orderId, payType);
            }
        }

        function closePage() {
            iPanel.eventFrame.showPay = false;
            window.close();
            iPanel.mainFrame.backPage();
        }

        //******************************打印处理**********************
        function iDebug(str) {
            if (navigator.appName.indexOf("iPanel") != -1) {
                iPanel.debug(str, 2); //假如要看打印的时间，可以改：iPanel.debug(str, 2);
            } else if (navigator.appName.indexOf("Opera") != -1) {
                opera.postError(str);
            } else if (navigator.appName.indexOf("Netscape") != -1 || navigator.appName.indexOf("Google") != -1) {
                console.log(str);
            }
        }

        function $(_id) {
            return document.getElementById(_id);
        }
    </script>
</head>

<body rightmargin="0" leftmargin="0" bgcolor="transparent">
    <div id="winBg" style="position:absolute; left:0px; top:0px; width:1280px; height:720px; background-color:#000000; opacity:0.85; "></div>

    <div id="totalDiv" style="position:absolute; left:230px; top:80px; width:830px; height:560px; color:#000000; font-size:28px;  visibility:visible;">
        <!--支付方式选择-->
        <div id="div0" style="width:300px; height:560px; position:absolute; left:0px; top:0px; font-size:28px; color:#000000;">
            <div style="font-size:28px; color:#e3fe3e3; width:300px; height:50px; line-height:50px; text-indent:20px; background-color:#ebebeb; position:absolute; left:0px; top:0px;">订单信息</div>
            <div style="font-size:28px;width:300px; height:100px; line-height:50px; text-indent:20px; background-color:#ffffff; position:absolute; left:0px; top:50px;"><span id="orderName">丛林大反攻4吓傻了</span><br /><span id="orderMoney" style=" padding-left:20px;">金额：3.00元</span></div>
            <div style="font-size:28px; color:#e3fe3e3; width:300px; height:50px; line-height:50px; text-indent:20px; background-color:#ebebeb; position:absolute; left:0px; top:150px;">请选择支付方式</div>
            <div id="rechargeType0" style="width:300px; height:89px; position:absolute; left:0px; top:200px;background-color:#ffb400; border-bottom:1px solid #e0e0e0;">
                <div style="position: absolute; left: 14px; top: 14px; width: 60px; height: 60px;"><img src="images/zhifu02.png" width="60" height="60"></div>
                <!--class="gray"-->
                <div style="position:absolute; left:86px; top:0px; line-height:90px; width:195px; height:90px;">微信支付</div>
                <div id="arrow_0" style="position: absolute; left: 284px; top: 39px; width: 10px; height: 14px; visibility:visible;"><img src="img/arrow.png" width="10" height="14"></div>
            </div>
            <div id="rechargeType1" style="width: 300px; height: 89px; position: absolute; left: 0px; top: 290px; background-color:#ffffff;  border-bottom:1px solid #e0e0e0;">
                <div style="position: absolute; left: 14px; top: 14px; width: 60px; height: 60px;"><img src="images/zhifu01.png" width="60" height="60"></div>
                <div style="position:absolute; left:86px; top:0px; line-height:90px; width:195px; height:90px;">支付宝支付 </div>
                <div id="arrow_1" style="position: absolute; left: 284px; top: 39px; width: 10px; height: 14px; visibility:hidden;"><img src="img/arrow.png" width="10" height="14"></div>
            </div>
            <div id="rechargeType2" style="width:300px; height:89px; position:absolute; left:0px; top:380px;background-color:#ffffff;border-bottom:1px solid #e0e0e0;">
                <div style="position: absolute; left: 14px; top: 14px; width:60px; height: 60px;"><img src="images/zhifu03.png" width="60" height="60"></div>
                <div style="position:absolute;left:86px;top:14px;width:195px;height:60px;line-height:30px;">银联在线支付<br/><span style="font-size:18px;">已开通无卡支付的银联</span></div>
                <div id="arrow_2" style="position: absolute; left: 284px; top:39px; width:10px; height:14px;visibility:hidden;"><img src="img/arrow.png" width="10" height="14"></div>
            </div>
            <div id="rechargeType3" style="width:300px; height:90px; position:absolute; left:0px; top:470px;background-color:#ffffff;">
                <div style="position: absolute; left: 14px; top: 14px; width: 60px; height: 60px;"><img src="images/zhifu04.png" width="60" height="60"></div>
                <div style="position:absolute; left:86px; top:14px; line-height:30px; width:195px; height:60px;">余额支付<br/><span id="balance" style="font-size:18px;">剩余金额：￥369</span></div>
                <div id="arrow_3" style="position: absolute; left: 284px; top: 39px; width: 10px; height: 14px; visibility:hidden;"><img src="img/arrow.png" width="10" height="14"></div>
            </div>
        </div>
        <!--二维码-->
        <div id="div1" style="position: absolute; left: 310px; top: 0px; width: 520px; height: 560px; background: #ffffff; text-align: center; visibility:visible;">
            <div style="position: absolute; left: 10px; top: 10px; width:500px; height:500px;">
                <img id="erweima" src="" width="500" height="500">
            </div>
            <div style="position: absolute; left: 10px; top: 520px; width: 500px; height: 41px; font-size: 25px; color: #000000; line-height: 35px; text-align: center;" id="erweimaText">&nbsp;</div>
        </div>
        <!--余额-->
        <div id="div2" style="position: absolute; left: 310px; top: 0px; width: 520px; height: 560px; background: #ffffff; text-align: center; visibility:hidden;">
            <div style="position: absolute; left: 68px; top: 222px; width:388px; height:161px;">
                <img id="payTips" src="img/pay.png" width="78" height="87">
                <div style="position:absolute; left:0px; top:88px; width:388px; height:72px; text-align:center"><span id="payText">您正在使用余额支付，<br/>确定继续支付请按"确定"键</span></div>
            </div>
        </div>
    </div>

</body>

</html>