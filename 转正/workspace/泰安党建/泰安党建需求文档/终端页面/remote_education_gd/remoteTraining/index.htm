<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>远程培训登录页面</title>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/ajax.js"></script>
<script type="text/javascript" src="../config/config.js"></script>
<script type="text/javascript">

/******************变量区域*************************/
var focusArea = 0;  //0:区域  1:下拉区域
var index = 4; //滑动地区索引值
var areaPosArr = [-1,-1,-1];  //标志地区位置index
var timer = -1;  //计时器标志
var showTipFlag = true;//提示框出现标志位
var menuBox;     //下拉框
var menuData = [];
var url = window.location.href;
var loginArea = "";
var optionsLen = 3;
var areaId;
var cmd = "";
var href = "";
var maxLen = 6; //键盘最大键入键值个数
var nameObj = [{
	"name":"党委",
	"focusStyle":{"focus":"../images/select12.png","blur":"../images/select11.png"}
},{
	"name":"基层党委",
	"focusStyle":{"focus":"../images/select12.png","blur":"../images/select11.png"}
},{
	"name":"基层党支部（A级）",
	"focusStyle":{"focus":"../images/select12.png","blur":"../images/select11.png"}
},{
	"name":"基层党支部（B级）",
	"focusStyle":{"focus":"../images/select12.png","blur":"../images/select11.png"}
},{
	"name":"确认按钮",
	"focusStyle":{"focus":"../images/btn_ok_0.png","blur":"../images/btn_ok_1.png"}
},{
	"name":"取消按钮",
	"focusStyle":{"focus":"../images/btn_cancel_0.png","blur":"../images/btn_cancel_1.png"}
}];
var menuLen = nameObj.length;

var parmsObj = {   //登陆homed的参数对象:泰安采用的CA
		"deviceno":cardNo,
		"devicetype":2,
		"account":"",
		"accounttype":1,
		"pwd":"",
		"accesstoken":"",
};

/*var parmsObj={   //登陆homed的参数对象:公司采用的是S/N,机顶盒号
		"deviceno":cardNo,
		"devicetype":1,//机顶盒
		"account":userName,//用户名
		"accounttype":2,//
		"pwd":userPwd,
		"accesstoken":"",
};*/

var playParms = {//缓存中的数据
	"token":"",
	"deviceid":"",
	"chnlid":"",
}

var focusObj={
	optionFocus:{
		hide:function(){
			$("optionDiv").style.visibility = "hidden";
		},
		show:function(){
			$("optionDiv").style.visibility = "visible";
			$("optionDiv").style.top = (55+index*75)+"px";		
		}
	},
	selFocus:{
		hide:function(){
			$("selectDiv").style.visibility = "hidden";
		},
		show:function(){
			$("selectDiv").style.visibility = "visible";
		}
	},
	areaFocus:{
		hide:function(){
			for(var i=0;i<menuLen;i++){
				$("focus"+i).style.background = "url("+nameObj[i].focusStyle.blur+") no-repeat";
			}
		},
		show:function(){
			$("focus"+index).style.background = "url("+nameObj[index].focusStyle.focus+") no-repeat"; 
		}	
	}
};


document.onkeydown = eventHandler;

function eventHandler(key){
  	var e = key || event;
  	var keycode = e.keyCode || e.which || e.charCode;
  	if(!showTipFlag && (keycode!=27 || keycode!=8)) return; 
 	switch (keycode) {
    case 1:   //up
    case 38:
		upAndDown(-1);
      	return false;
      	break;
    case 2:   //down
    case 40:
      	upAndDown(1);
      	return false;
      	break;
    case 3:
    case 37:  
    	changeLR(-1);
    	break;
	case 4:
	case 39:
		changeLR(1);
		break;
    case 13:
      	doSelect();
      	return false;
      	break;
    case 27:
    case 8:
		window.location.href = "../index.htm";	
      	event.returnValue = false;
      	return false;
      	break;
	}
}


function upAndDown(_num){
	if(focusArea==0){
		focusObj.areaFocus.hide();
		if((index==0 && _num<0) || ((index==4 || index==5) && _num>0)){
		}else if((index == 4 || index==5) && _num<0){ 
			index = 3;
		}else{
			index = (index+_num+menuLen)%menuLen;
		}
	}else if(focusArea==1){
		if($("optionDiv").style.visibility=="visible" && _num<0 && menuBox.position==0){
			focusArea = 0;
			menuBox="";
		}else{
			menuBox.changeList(_num);
			$("selectDiv").innerText=currData[menuBox.position].name;
			return;
		}	
	}
	//focusObj.optionFocus.hide();
	//focusObj.selFocus.hide();
	focusObj.areaFocus.show();
}

function changeLR(_num){
	focusObj.areaFocus.hide();
	if((_num>0 && index==4) || (_num < 0 && index==5)){
		index += _num;
	}else if(index == 3 &&　_num < 0){
		cancelNum();
	}
	focusObj.areaFocus.show();
}

function doSelect(){
	if(focusArea == 0){
		areaSelect();
	}else if(focusArea == 1){
		/*$("text"+index).innerText = currData[menuBox.position].name;
		downSelect();
		focusArea = 0;
		focusObj.optionFocus.hide();
		focusObj.selFocus.hide();
		focusObj.areaFocus.show();*/
	}
}


function areaSelect(){
	switch(index){
		case 0:
		case 1:
		case 2:  
			/*menuBox="";
			currData="";
			if(index==0){
				currData=menuData;
			}else if(areaPosArr[0]!=-1 && index==1){
				currData=menuData[areaPosArr[0]].children;
			}else if(areaPosArr[0] !=-1 &&　areaPosArr[1] != -1 && index==2){
				currData=menuData[areaPosArr[0]].children[areaPosArr[1]].children;
			}
			if(currData.length == 0 || typeof(currData)=="undefined"){
				focusObj.optionFocus.hide();
				return;
			}
			focusObj.optionFocus.show();
			initOptions(currData);*/
			break;
		case 3:
			//initKeyBoard();
			break;
		case 4: 
			login();
			break;
		case 5: 
			clearAll();
			break;
	}
}
function initKeyBoard(){
	$("key_board").style.visibility = "visible";
	$("focusDiv").style.visibility = "visible";
	keyBoard_init();
	initBoard("identifyCode",currIdentifyCode,maxLen,window,replaceStr,234,130,916,306);
	kBShowFlag = true;
}

function downSelect(){
	switch(index){
		case 0: //联动:需要对重新刷新index
			if(areaPosArr[0] != menuBox.position){
				areaPosArr[1] = -1;
				areaPosArr[2] = -1;
				$("text1").innerText="";
				$("text2").innerText="";
			}
			areaPosArr[0]=menuBox.position;
			break;
		case 1:
			if(areaPosArr[1]!=menuBox.position){
				areaPosArr[2] = -1;
				$("text2").innerText="";
			}
			areaPosArr[1] = menuBox.position;	
			break;
		case 2:
			areaPosArr[2] = menuBox.position;
			break;
	}
}

function login(){
	/*if(areaPosArr[0]==-1){
		showTips("党工委是必选项!");
		isMatch = false;
		return;
	}
	if(currIdentifyCode == ""){
		showTips("会议识别码必须填写,不能为空!");
		isMatch = false;
		return;
	}
	if(areaPosArr[0]!= -1 && areaPosArr[1]==-1 &&  areaPosArr[2]==-1){
		 loginArea = menuData[areaPosArr[0]].name;
		 areaId = menuData[areaPosArr[0]].id;
	}	
	if(areaPosArr[0]!= -1 && areaPosArr[1]!=-1 &&  areaPosArr[2]==-1){
		 loginArea = menuData[areaPosArr[0]].children[areaPosArr[1]].name;
		 areaId = menuData[areaPosArr[0]].children[areaPosArr[1]].id;
	}
	if(areaPosArr[0]!=-1 && areaPosArr[1]!=-1 &&  areaPosArr[2]!=-1){
		 loginArea = menuData[areaPosArr[0]].children[areaPosArr[1]].children[areaPosArr[2]].name;
		 areaId = menuData[areaPosArr[0]].children[areaPosArr[1]].children[areaPosArr[2]].id;
	}*/
	if(playParms.token!="" && playParms.deviceid!=""){  //&& playParms.chnlid!=""
		window.location.href = href;
	}else{
		getUserList();
	}	
}

function getUserList(){
	var url = getUseInfo;
	if(!isGet){
		url = url.replace("{0}",parmsObj.deviceno).replace("{1}",parmsObj.devicetype);
	}
	iDebug(">>>zhaoql:index--getUserList--url="+url);
	ajax({
		url:url,
		type: "GET",
		dataType: "json",
		onSuccess: function(responseText){
			var res = eval('('+responseText+')');
			var	userArr = res.user_list;
			if(res.ret == "0" && userArr && userArr.length>0){
				parmsObj.account = userArr[0].user_id;			
				parmsObj.pwd = parmsObj.accesstoken==""?userPwd:"";
				iDebug(">>>zhaoql:index--getUserList--userId="+parmsObj.account+"|password="+parmsObj.pwd+"|token="+parmsObj.accesstoken);
				checkPwd();	
			}
		},
		onError:function(){
			iDebug(">>>zhaoql:index--getUserList fail");
		}
	});	
}



function checkPwd(){
	iDebug(">>>zhaoql:index--checkPwd--token="+parmsObj.accesstoken);
	var url = homedLogin;	
	if(!isGet){
		url = url.replace("{0}",parmsObj.deviceno).replace("{1}",parmsObj.devicetype).replace("{2}",parmsObj.accounttype).replace("{3}",parmsObj.account).replace("{4}",parmsObj.pwd).replace("{5}",parmsObj.accesstoken);
	}
	iDebug(">>>zhaoql:index--checkPwd--url="+url);
	ajax({
		url:url,// 请求服务器
		type: "GET",
		dataType: "json",
		onSuccess: function(responseText){
			iDebug(">>>checkPwd()---responseText="+responseText);
			var tempObj = eval('('+responseText+')');
			if(typeof(tempObj) == "undefined" || tempObj.ret!="0"){  //未匹配
				showTips("CA与党组织未对应:"+tempObj.ret_msg);
			}else if(tempObj.ret == "0"){   //匹配成功:昵称与选择的区域做对比
				//if(tempObj.nick_name == loginArea){
					if(parmsObj.accesstoken == ""){
						iDebug("index--checkLogin--loginToken="+tempObj.access_token+"|deviceid="+tempObj.device_id);		
						setGlobalParms({"ycpx_loginToken":tempObj.access_token,"ycpx_deviceId":tempObj.device_id,"ycpx_areaId":areaId,"ycpx_loginArea":loginArea});
						//"ycpx_identifyCode":currIdentifyCode,"ycpx_areaPosArr":areaPosArr,"ycpx_loginArea":loginArea,
						window.location.href = href;
					}
				//}else{
				//	showTips("当前CA卡号与党组织不匹配!");
				//}
			}
		},
		onError:function(){
			iDebug(">>>checkPwd--request--error");
		}
	});
}


function showTips(__str){
	$("tip_div").style.visibility = "visible";
	$("tip_cont").innerText = __str;
	showTipFlag = false;
	clearTimeout(timer);
	timer = setTimeout(function(){
		$("tip_div").style.visibility="hidden";
		showTipFlag = true;
	},2000);
}


function clearAll(){
	for(var i=0;i<menuLen-3;i++){
		$("text"+i).innerText = "";
	}
	menuBox = "";
	areaPosArr = [-1,-1,-1];
}


function initOptions(__optionArr){
	menuBox = new showList(optionsLen, __optionArr.length, 0, 262+75*index, window);
	menuBox.focusDiv = "selectDiv";//焦点元素的ID
	menuBox.listHigh = 52;         //行高
	//menuBox.listSign = 1;        //表示横向移动，不设置则默认为竖向
	menuBox.focusLoop = false;     //是否循环切换
	menuBox.pageLoop = true;       //是否循环翻页
	menuBox.haveData = function(List){    //显示一行数据
	   $("area"+List.idPos).innerText = __optionArr[List.dataPos].name;
	};
	menuBox.notData = function(List){    //清空一行数据
	   $("area"+List.idPos).innerText = "";
	};
	$("selectDiv").innerText = __optionArr[menuBox.position].name;
	menuBox.startShow(); //开始显示列表信息
}

function init(){
	getParms();
	getAreaInfoByCA();
	focusObj.areaFocus.hide();
	focusObj.areaFocus.show();	
}

function getParms(){	
	var token = getGlobalParms("ycpx_loginToken");
	parmsObj.accesstoken = token;
	playParms.token = token;
	
	var res = getGlobalParms("cmd");
	if(res!=""){
		if(res == "fromSelectFun"){
			href = "selectFun.htm";     //三会一课--》登陆--》选择功能
		}else if(res == "fromIndex"){
			href = "trainingRecord.htm";//首页更多--》登陆--》视频回看
		}
	}
	
	var tempDeviceId = getGlobalParms("ycpx_deviceId");
	if(tempDeviceId!=""){
		playParms.deviceid = parseInt(tempDeviceId,10);
	}
	
	var tempChanId = getGlobalParms("ycpx_chnlId");
	if(tempChanId != ""){
		playParms.chnlid = parseInt(tempChanId,10);
	}
	
	/*var tempStr = getGlobalParms("ycpx_areaPosArr");
	if(tempStr!= ""){
		var tempArr = tempStr.split(",");
		for(var i=0,len=tempArr.length;i<len;i++){
			areaPosArr[i] = parseInt(tempArr[i],10);
			playParms.areaPosArr[i] = parseInt(tempArr[i],10);
		}
	}	
	var tempIdentifyCode = getGlobalParms("ycpx_identifyCode");//获取会议识别码
	if(tempIdentifyCode!=""){
		playParms.identifyCode = parseInt(tempIdentifyCode,10);
	}*/
	iDebug("index--getParms--token="+token+"|deviceId="+tempDeviceId+"|chnlid="+tempChanId);
}


//获取该CA下的区域信息
function getAreaInfoByCA(){
	var url = queryLoginPlaceUrl;
	if(!isGet){
		url = url.replace("{0}",parmsObj.deviceno);
	}
	iDebug("index--getAreaInfoByCA--url="+url);
	ajax({
		url:url,// 请求服务器
		type: "GET",
		dataType: "json",
		onSuccess: function(responseText){
			iDebug(">>>getAreaInfoByCA--responseText="+responseText);
			var tempObj = eval('('+responseText+')');
			if(typeof tempObj!="undefined" && tempObj.result=="E0000"){
				menuData = tempObj.msg;
				initLoginInfo();
			}else{
				showTips("error:"+tempObj.msg);
			}
		},
		onError:function(){
			iDebug(">>>getAreaInfoByCa--request--error");
		}
	});
}


function initLoginInfo(){
	if(typeof menuData!="undefined" && typeof (menuData.areaLevel)!="undefined" && (menuData.areaLevel)!=""){
		iDebug(">>>initLoginInfo--areaLevel="+menuData.areaLevel);
		$("text"+(menuData.areaLevel-1)).innerText = menuData.placeName;
		loginArea = menuData.placeName;
		areaId = menuData.areaId;
		var parentArea = menuData.parentArea;
		if(parentArea.length>0){
			for(var i=0,len = parentArea.length;i<len;i++){
				$("text"+(parentArea[i].areaLevel-1)).innerText = parentArea[i].areaName;
			}
		}
	}
}

</script>
</head>

<body leftmargin="0" topmargin="0" background="../images/bg.jpg" onload="init();">

<!--logo-->
<div style="position:absolute; left:1087px; top:50px;"><img src="../images/ycpx.png" width="118" height="54"/></div>

<!--全程纪实-->
<div style="position: absolute; left: 66px; top: 158px; width: 1148px; height: 420px; background: url(../images/listBtm02.png) no-repeat;">
  <div style="position: absolute; left: 295px; top: 7px; width: 600px; height: 343px;">
	
  <!--会场选择-->
  <!--第一级-->
  <div style="position: absolute; left: -24px; top: 4px; width: 182px; height: 88px; line-height: 105px; color: #fdf9f6; font-size: 28px; text-align: right">党委</div>
	<div style="position:absolute; left:145px; top:0px; width:404px; height:113px; background:url(../images/select12.png) no-repeat;" id="focus0">
	  <div style="position:absolute; left:65px; top:29px; width:265px; height:55px; line-height:55px; font-size:24px; color:#232221; " id="text0">
    </div>
  </div>
  
  <!--第二级-->
  <div style="position: absolute; left: -25px; top: 75px; width: 182px; height: 105px; line-height: 105px; color: #fdf9f6; font-size: 28px; text-align: right">基层党委</div>
	<div style="position:absolute; left:145px; top:75px; width:404px; height:113px; background:url(../images/select11.png) no-repeat;" id="focus1">
	  <div style="position:absolute; left:65px; top:29px; width:265px; height:55px; line-height:55px; font-size:24px; color:#232221; " id="text1">
    </div>
  </div>
  
  <!--第三级-->
  <div style="position: absolute; left: -97px; top: 150px; width: 254px; height: 105px; line-height: 105px; color: #fdf9f6; font-size: 28px; text-align: right">基层党支部(A级)</div>
	<div style="position:absolute; left:145px; top:150px; width:404px; height:113px; background:url(../images/select11.png) no-repeat;" id="focus2">
	  <div style="position:absolute; left:65px; top:29px; width:265px; height:55px; line-height:55px; font-size:24px; color:#232221; " id="text2">
    </div>
  </div>
  
  <!--第四级-->
  <div style="position: absolute; left: -97px; top: 232px; width: 256px; height: 80px; line-height: 105px; color: #fdf9f6; font-size: 28px; text-align: right">基层党支部(B级)</div>
	<div style="position:absolute; left:145px; top:225px; width:404px; height:113px; background:url(../images/select11.png) no-repeat;" id="focus3">
	  	<div style="position:absolute; left:65px; top:29px; width:265px; height:55px; line-height:55px; font-size:24px; color:#232221;" id="text3">
    </div>
  </div>
  
  <!--确认按钮-->
  <div id="focus4" style="position: absolute; left: 166px; top: 334px; width: 126px; height: 45px; text-align: center; background: url(../images/btn_ok_1.png) no-repeat;"></div>
  
  <!--取消按钮-->
  <div id="focus5" style="position: absolute; left: 384px; top: 332px; width: 126px; height: 45px; text-align: center; background: url(../images/btn_cancel_1.png) no-repeat;"></div>
 </div>
 

  <!--提示-->
  <div id="tip_div" style="position: absolute; left: 300px; top: 25px; width: 560px; height: 360px; background: url(../images/tck_bg.png) center no-repeat; visibility: hidden;">
    <table align="center" width = "500" height="340" border="0" cellspacing="0" cellpadding="0" style="font-size:28px; color:#FFFFFF;">
      <tr>
          <td height="60" align="center">温馨提示</td>
      </tr>
      <tr>
  	      <td height="150" align="center" style="font-size:25px;" id="tip_cont"></td>
      </tr>
      <!--<tr>
     	  <td height="90"></td>
      </tr>-->
     </table>
   </div>
</div> 
<!--测试使用-->
<div style="position: absolute; width: 388px; height: 462px; border: #F00 3px solid; left: 75px; top: 112px; visibility:hidden" id="test"></div>

</body>
</html>
