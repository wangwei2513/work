<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>通用模板</title>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
var menuDataUrl = "content.js";
var menuData = [];
var bgData = [];
var ajaxObj = null;
var pageNum = 5;
var currPage = 0;
var totalPage = 0;
var subPos = 0;
var backUrl = "../index.htm"
function getTitleData() {
  if(ajaxObj != null){
    ajaxObj.requestAbort();
  }
  ajaxObj = new AjaxClass();
  ajaxObj.frame = window;
  ajaxObj.charset = "utf-8";
  ajaxObj.successCallback = function(_xmlHttp, _params) {
    var jsonData = eval('(' + _xmlHttp.responseText + ')');
    if(typeof(jsonData) != "undefined" && jsonData.length > 0){
      var titleData = jsonData;
      var title = "通用模版||文字||" + titleData.navigator +"||"+titleData.name;
      try{
        DataCollection.collectionData(["01",location.href,location.referrer,title,"",""])
      }catch(e){};
      
    }
  };
  ajaxObj.failureCallback = function(_xmlHttp, _params) {};
  ajaxObj.url = "node.js";
  ajaxObj.requestData();
}
document.onkeydown = eventHandler;
function eventHandler(key){
  	var e = key || event;
  	var keycode = e.keyCode || e.which || e.charCode;
  	switch (keycode) {
    	case 87:   // up
    	case 38:
      		leftAndRight(-1);
      		return false;
      		break;
    	case 83:   // down
    	case 40:
     		leftAndRight(1);
      		return false;
      		break;
    	case 65:   // left
    	case 37:
      		leftAndRight(-1);
      		return false;
      		break;
    	case 68:   // right
    	case 39:
      		leftAndRight(1);
      		return false;
      		break;
    	case 13:
	 		doSelect();
      		return false;
      		break;
    	case 8:
      		goBack();
      		event.returnValue = false;
      		return false;
      		break;
    	case 27:
      		iSTB.browser.gotoSTB("tv");
      		event.returnValue = false;
      		return false;
     	 	break;
  	}
}

function leftAndRight(_num){	
	if(menuData.length==0)return;
  	$("sub_name_"+subPos).innerText = subStr(menuData[currPage*pageNum+subPos].title,12);
  	if(_num > 0){
    	if(subPos == pageNum -1 && currPage < totalPage-1){
      		currPage += _num;
      		subPos = 0;
      		initMenuData();
    	}else{
      		subPos = subPos + _num;
    	}
  	}else{
    	if(subPos == 0 && currPage>0){
      		currPage += _num;
      		subPos = pageNum - 1;
      		initMenuData();
    	}else{
      		subPos = subPos+_num;
    	}
  	}
  	if(subPos + currPage * pageNum > menuData.length-1) subPos = (menuData.length-1) % pageNum;
  	if(subPos + currPage * pageNum < 0) subPos = 0;
  	initMenuData();
  	initFocus();
}

function doSelect(){
	if(typeof menuData == "undefined" || menuData.length<=0)return;
	mySessionStorage.setItem("normalMenuPos",subPos+currPage*pageNum);
	window.location.href = menuData[subPos+currPage*pageNum].videoUrl;
}

function goBack(){
	mySessionStorage.removeItem("normalMenuPos");
	window.location.href = backUrl;
}

function init(){
	getMenuData();
  getTitleData();
}

function getMenuData() {
	if(ajaxObj != null){
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "utf-8";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		var jsonData = eval('(' + _xmlHttp.responseText + ')');
		if(typeof(jsonData) != "undefined" && jsonData.length > 0){
			for (var i = 0,len = jsonData.length; i < len; i++) {
        if (jsonData[i].author != "") {
          bgData.push(jsonData[i]);
        }else{
          menuData.push(jsonData[i]);
        }
				
			}
			iDebug(menuData);
			getItemPos();
      initbg();
			initMenuData();
			initFocus();
		}
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {
	};
	ajaxObj.url = menuDataUrl;
	ajaxObj.requestData();
}


function getItemPos(){
	var position = 0;
	var tmpPara = mySessionStorage.getItem("normalMenuPos");	
	if(tmpPara != ""){
		position  = parseInt(tmpPara,10);
	} 
	subPos = position%pageNum;
  	currPage = Math.floor(position/pageNum); 	
}

function initbg() {
  if (bgData.length != 0) {
    $("bg").src = bgData[0].entryImage.imageUrl;
  }
}

function initMenuData(){ 
	totalPage = Math.ceil(menuData.length/pageNum);
	$("sub_focus").style.visibility = "visible";
    for(i = 0; i < pageNum; i++){
      if(currPage * pageNum + i < menuData.length){
        $("sub_poster_"+i).style.background = "url(" + menuData[currPage*pageNum+i].entryImage.imageUrl + ")";
        $("sub_name_"+i).innerText = subStr(menuData[currPage*pageNum+i].title,6);
        $("sub_name_"+i).style.backgroundImage = "url(images/pic_cover.png)";
      }else{
        $("sub_poster_"+i).style.background = "url()";
        $("sub_name_"+i).innerText = "";
        $("sub_name_"+i).style.backgroundImage = "url()";
      }
    }
}

function initFocus(){ // left: 35px; top: 28px; width: 357px; height: 249px;
  $("sub_focus").style.left = subPos * 226.4 + 98 + "px";
  if(menuData[currPage*pageNum+subPos].title.length>11){
    $("sub_name_"+subPos).innerHTML = "<marquee style=\"width:165px;\">"+menuData[currPage*pageNum+subPos].title+"</marquee>";
  }
}
</script>
</head>
<body style="background:url(images/bg.jpg) no-repeat;" onload="init()">
  <img id="bg" src="" alt="" style="position:absolute; left: 0px; top: 0px; width: 1280px; height: 720px;" />
	<!--人物简介-->
	<!--分割线-->
	<!--左右按钮-->
	<img src="images/att_01.png" style="position:absolute;left:77px;top:554px;"/>
	<img src="images/att_02.png" style="position:absolute;left:1205px;top:554px;"/>
	<!--下方列表-->
	<div id="sub_poster_0" style="position:absolute;left:116px;top:425px;width:167px;height:248px;">
		<!--cover-->
		<div id="sub_name_0" style="position:absolute;left:0px;top:207px;width:167px;height:41px;color:#d2dce6;font-size:20px;text-align:center;line-height:41px;">			
		</div>
	</div>
	<div id="sub_poster_1" style="position:absolute;left:342px;top:422px;width:168px;height:252px;">
		<!--cover-->
		<div id="sub_name_1" style="position:absolute;left:0px;top:211px;width:168px;height:41px;color:#d2dce6;font-size:20px;text-align:center;line-height:41px;">
		</div>
	</div>
	<div id="sub_poster_2" style="position:absolute;left:569px;top:422px;width:167px;height:252px;">
		<!--cover-->
		<div id="sub_name_2" style="position:absolute;left:0px;top:211px;width:167px;height:41px;color:#d2dce6;font-size:20px;text-align:center;line-height:41px;">
		</div>
	</div>
	<div id="sub_poster_3" style="position:absolute;left:795px;top:422px;width:167px;height:252px;">
		<!--cover-->
		<div id="sub_name_3" style="position:absolute;left:0px;top:210px;width:167px;height:41px;color:#d2dce6;font-size:20px;text-align:center;line-height:41px;">
		</div>
	</div>
	<div id="sub_poster_4" style="position:absolute;left:1022px;top:422px;width:167px;height:252px;">
		<!--cover-->
		<div id="sub_name_4" style="position:absolute;left:0px;top:210px;width:167px;height:41px;color:#d2dce6;font-size:20px;text-align:center;line-height:41px;">
		</div>
	</div>
	<!--焦点-->
	<img id="sub_focus" src="images/focus_pop.png" style="position:absolute;left:98px;top:408px;width: 203px;height: 285px;visibility: hidden;"/>
</body>
</html>
