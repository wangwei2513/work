<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>无标题文档</title>
<style>
.mf{ position:absolute; left:0px; top:110px; width:244px; height:63px; background:url(images/mf01.png) no-repeat; text-align:center; padding-top:5px; color:#a08e7c; line-height:50px;}
.column_txt0 {height:42px; font-size:24px; color:#000; line-height:42px; text-align:center; }
.mf1 {position:absolute; left:0px; top:110px; width:245px; height:82px; background:url(images/mf01.png) no-repeat; text-align:center; color:#559013; line-height:82px;}
</style>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript">
var dataAjaxPath = "content.js";
var logoAjaxPath = "";
var navTitleAjaxPath = "node.js";
var cellPadValue = 10;
var ajaxObj = null;
var logoAjaxObj = null;

var itemLen = 8;
var column = 4;
var row = 2;
var itemMaxSize = 10;
var itemPos = 0;

var itemBox = null;
var scrollBox = null;
var menuData = [];

var havaBackUrl = true;
var backUrl = "../index.htm";



document.onkeydown = eventHandler;
function eventHandler(key){
  	var e = key || event;
  	var keycode = e.keyCode || e.which || e.charCode;
  	switch (keycode) {
    	case 1:   // up
    	case 38:
      		keyAction(-1,"UP");
      		return false;
      		break;
    	case 2:   // down
    	case 40:
      		keyAction(1,"DOWN");
      		return false;
      		break;
    	case 3:   // left
   		case 37:
      		keyAction(-1,"LEFT");
      		return false;
      		break;
    	case 4:   // right
    	case 39:
      		keyAction(1,"RIGHT");
      		return false;
      		break;
    	case 13:
      		doSelect();
      		return false;
      		break;
    	case 8:
      		goBack();
      		event.returnValue = false;
      		return false;
      		break;
    	case 27:
      		iSTB.browser.gotoSTB("tv");
      		event.returnValue = false;
      		return false;
      		break;
	}
}


function goBack(){
	mySessionStorage.removeItem("itemPos");
	if(havaBackUrl){
		window.location.href = backUrl;
	}else{
		goPortal();
	}
}


function doSelect(){
	if(itemBox!=null){
		mySessionStorage.setItem("itemPos",itemBox.position);
		window.location.href = menuData[itemBox.position].linkUrl ;
	}
}

function keyAction(_num,direction){
	if(itemBox!=null){
		/*if((_num<0 && direction=="UP" && (itemBox.focusPos>=0 && itemBox.focusPos<column))|| (_num>0 && direction=="DOWN" && (itemBox.focusPos>=column && itemBox.focusPos<=itemLen-1))){
			return;
		}*/
		clearFocus();
		if(direction=="LEFT" || direction=="RIGHT"){
			itemBox.changeList(_num);
		}else if(direction=="UP" || direction=="DOWN"){
			itemBox.changeList(_num*column);
		}
		scrollBox.scroll(itemBox.position);
		showScrollPage();
		showFocus();
	}
}

function init(){
	getParms();
	checkBackUrl();
	ajaxLoadMenuData();
	//ajaxLoadLogo();
	//showTime();
}

function getParms(){
	var tempItemPos = mySessionStorage.getItem("itemPos");
	if(tempItemPos!=""){
		itemPos = parseInt(tempItemPos,10);
	}
	//iDebug(">>>getParms--itemPos="+itemPos);
}


function checkBackUrl(){
	ajaxObj  = null;
	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		havaBackUrl = true;
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {
		havaBackUrl = false;
		//iDebug(">>>ajaxLoadMenuData failureCallback");
	};
	ajaxObj.url = backUrl;
	//iDebug(">>>ajaxLoadMenuData ajaxObj.url=" + ajaxObj.url);
	ajaxObj.requestData();
}

function ajaxLoadMenuData(){
	ajaxObj = null;
	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var jsonData = eval('(' + _xmlHttp.responseText + ')');
		if(typeof(jsonData) != "undefined" && jsonData.length > 0){
			menuData = jsonData;
			showItem();
		}else{
			noItemData();
			initScroll();	
		}
		ajaxNavTitle();
		checkBackUrl();
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData failureCallback");
		ajaxNavTitle();
		checkBackUrl();
		noItemData();
		initScroll();	
	};
	ajaxObj.url = dataAjaxPath;
	//iDebug(">>>ajaxLoadMenuData ajaxObj.url=" + ajaxObj.url);
	ajaxObj.requestData();
}

function initScroll(){
	scrollBox = null;
	if(itemBox!=null){
		$("barDiv").style.visibility = "visible";
		listDataLength = menuData.length;
		scrollBox = new ScrollBar("barDiv", "barDiv", window);
		scrollBox.init(listDataLength, listDataLength, 492, 0, 61);
		scrollBox.scroll(itemBox.position);
		showScrollPage();
	}else{
		noScrollBar();
	}
}


function ajaxNavTitle(){
	ajaxObj = null;
	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var jsonData = eval('(' + _xmlHttp.responseText + ')');
		if(typeof(jsonData) != "undefined"){
			if(jsonData.navigator!=""){
				$("navTitle").innerText = jsonData.navigator;
			}
		}else{}
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {};
	ajaxObj.url = navTitleAjaxPath ;
	ajaxObj.requestData();
}

function noItemData(){
	for(var i=0;i<itemLen;i++){
		$("entryImage"+i).src = "images/global_tm.gif";
		$("title"+i).innnerText = "";
	}
	$("itemFocus").style.visibility = "hidden";
}


function showItem(){
	itemBox = new showList(itemLen,menuData.length,itemPos,-65,window);
	itemBox.focusDiv = "focus";
	itemBox.focusLoop  = true; 
	itemBox.haveData = function(_list){
		$("title" + _list.idPos).innerHTML = subStr(menuData[_list.dataPos].title,itemMaxSize,"...");
		$("entryImage"+_list.idPos).src = (menuData[_list.dataPos].entryImage==null)?"images/default.png":menuData[_list.dataPos].entryImage.imageUrl;
	};
	itemBox.notData = function(_list){
		$("title" + _list.idPos).innerHTML = "";
		$("entryImage"+_list.idPos).src = "images/global_tm.gif";
	};
	itemBox.startShow();
	initScroll();
	//焦点位置
	clearFocus();
	showFocus();
}

function clearFocus(){
	$("title" + itemBox.focusPos).innerHTML = subStr(menuData[itemBox.position].title,itemMaxSize,"...");
}

function showFocus(){
	if(getStrChineseLength(menuData[itemBox.position].title)>itemMaxSize){
		$("title" + itemBox.focusPos).innerHTML = "<marquee width=235>"+menuData[itemBox.position].title+"</marquee>";
	}
	$("itemFocus").style.visibility = "visible";
	$("itemFocus").style.left = (-26+(itemBox.focusPos%column)*273)+"px";
	$("itemFocus").style.top = (-23+parseInt(itemBox.focusPos/column,10)*245)+"px";
}


function noScrollBar(){
	$("barDiv").style.visibility = "hidden";
	$("currPage").innerText  = 0;
	$("totalPage").innerText = 0;
	scrollBox = null;
}

function showScrollPage(){
	if(itemBox!=null){
		$("currPage").innerText  = itemBox.position+1;
		$("totalPage").innerText = menuData.length;
	}
}

function ajaxLoadLogo(){
	if (logoAjaxObj != null) {
		logoAjaxObj.requestAbort();
	}
	logoAjaxObj = new AjaxClass();
	logoAjaxObj.frame = window;
	logoAjaxObj.charset = "gbk";
	logoAjaxObj.successCallback = function(_xmlHttp, _params){
		//iDebug(">>>ajaxLogoData successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var jsonData = eval('(' + _xmlHttp.responseText + ')');
		if(typeof(jsonData) != "undefined" && jsonData.length > 0){
			if(typeof jsonData[0].logoImageUrl!="undefined" && jsonData[0].logoImageUrl!=""){
				$("logoImage").src = jsonData[0].logoImageUrl;
			}else{
				$("logoImage").src = "images/global_tm.gif";
			}
		}else{
			$("logoImage").src = "images/global_tm.gif";
		}
	};
	logoAjaxObj.failureCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLogoData failureCallback");
		$("logoImage").src = "images/global_tm.gif";
	};
	logoAjaxObj.url = logoAjaxPath;
	//iDebug(">>>ajaxLogoData logoAjaxObj.url=" + logoAjaxObj.url);
	logoAjaxObj.requestData();
}

function showTime(){
	var currTime = formatTime("yyyy-MM-dd hh:mm",new Date());
	$("time").innerText = currTime;
	setTimeout("showTime()",1000);
}

</script>
</head>

<body background="images/tm_bg.jpg" leftmargin="0" topmargin="0" onload="init();">
<div style="position: absolute; left: 230px; width: 844px; height: 49px; top: 32px; line-height: 49px; font-size: 27px" id="navTitle"></div>
<!--推荐-->
<div style="position:absolute; left:76px; top:131px; width:1095px; height:241px;">
  <div style="position:absolute; left:0px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage0"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title0">&nbsp;</td>
      </tr>
    </table>
  </div>
  <div style="position:absolute; left:273px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage1"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title1">&nbsp;</td>
      </tr>
    </table>
  </div>
  <div style="position:absolute; left:546px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage2"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title2">&nbsp;</td>
      </tr>
    </table>
  </div>
  
  <div style="position: absolute; left: -26px; top: -23px; width: 315px; height: 245px; background-image: url(images/column_focus0.png); -webkit-animation-duration: 500ms; visibility:hidden" id="itemFocus"></div>
 	<!--fake focus-->
  <div style="position:absolute;" id="focus"></div>
  
  <div style="position:absolute; left:819px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage3"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title3">&nbsp;</td>
      </tr>
    </table>
  </div>
</div>
<!--条目-->
<div style="position:absolute; left:76px; top:376px; width:1095px; height:240px;">
  <div style="position:absolute; left:0px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage4"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title4">&nbsp;</td>
      </tr>
    </table>
  </div>
  <div style="position:absolute; left:273px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage5"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title5">&nbsp;</td>
      </tr>
    </table>
  </div>
  <div style="position:absolute; left:546px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage6"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title6">&nbsp;</td>
      </tr>
    </table>
  </div>
  <div style="position:absolute; left:819px; top:0px; width:240px; height:193px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><img src="" width="263" height="192" id="entryImage7"/></td>
      </tr>
      <tr>
        <td class="column_txt0" id="title7">&nbsp;</td>
      </tr>
    </table>
  </div>
</div>
<!--游走字幕-->
<div style="position: absolute; left: 1187px; top: 127px; width: 3px; height: 492px; background-color: #828282;">
  <div style="position:absolute; left:-12px; top:0px; width:29px; height:61px; background-image: url(images/page.png); visibility:hidden" id="barDiv">
    <div style="position:absolute; left:0px; top:0px; width:29px; height:29px; font-size:24px; color:#ffffff; text-align:center;" id="currPage"></div>
    <div style="position:absolute; left:0px; top:31px; width:29px; height:29px; font-size:24px; color:#ffffff; text-align:center;" id="totalPage"></div>
  </div>
</div>
</body>
</html>
