<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>监控列表</title>
</head>
<script src="js/common.js"></script>
<script>
var dataAjaxPath = "content.js";
var navTitleAjaxPath = "node.js";
var cellPadValue = 10;
var ajaxObj = null;

var menuData = [];    	  //条目数组
var noDataFlag = true;   //无数据的标志
var itemBox = null;      //条目列表的对象
var itemPos = 0;         //条目焦点位置
var pageNum = 6;		 //一页显示多少条目
var localVideoUrl = "";	 //正在播的播放地址
var randomPlayStatus = false;	//随机播放模式
var playTimer = -1;				//播放计时器
var focusArea = 0;	//焦点区域 0：左侧列表 1：右侧视频

var itemFocusArray = [ 
  {left: "-11px", top: "-66px", width:"744px", height:"65px"},
  {left: "-11px", top: "-1px", width:"744px", height:"65px"},
  {left: "-11px", top: "64px", width:"744px", height:"65px"},
  {left: "-11px", top: "129px", width:"744px", height:"65px"},
  {left: "-11px", top: "194px", width:"744px", height:"65px"},
  {left: "-11px", top: "259px", width:"744px", height:"65px"}
];

//获取token令牌
// var stbid = "8538002343839692";//默认CA卡序列号
var stbid = getCAId();//获取CA卡序列号
var bootAutoLogin = 0;
var accessToken = "";
var password = "";
var addr = ["http://10.191.150.101:12690","http://10.191.150.102:12690"][0];

var havaBackUrl = false;
var backUrl = "../index.htm";


document.onkeydown = eventHandler;

function eventHandler(key){
    var e = key || event;
    var keycode = e.keyCode || e.which || e.charCode; 
    if(noDataFlag&&keycode!=8&&keycode!=27){
      return false;
    }
    switch (keycode) {
    case 1:
	case 38://up
			changeUD(-1);
			break;
		case 2:
		case 40://down
			changeUD(1);
			break;
		case 3:
		case 37://left
			changeLR(-1);
			break;
		case 4:
		case 39://right
			changeLR(1);
			break;
    	case 13:
      		doSelect();
      		return false;
      		break;
		case 114://blue
	  		//changePlayMode();
	  		return false;
      		break;
    	case 27:
		case 8:
			doBack();
      		event.returnValue = false;
      		return false;
      		break;
		}
}
function getUserInfo(){	
	ajaxObj = null;
 	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var res = eval('('+_xmlHttp.responseText+')');
		var	userArr = res.user_list;
		if(res.ret == "0" && userArr && userArr.length>0){
			bootAutoLogin = userArr[0].user_id;			
			password = accessToken==""?"96e79218965eb72c92a549dd5a330112":"";
			userLogin(1,bootAutoLogin,password,accessToken,userArr[0].user_name);	
		}
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData failureCallback");
	};
	ajaxObj.url = addr+"/account/user/get_list?deviceno="+stbid+"&devicetype=2&iconsize=140x140";
	//iDebug(">>>ajaxLoadMenuData ajaxObj.url=" + ajaxObj.url);
	ajaxObj.requestData();
}


function userLogin(_type,user_id,_pwd,_token,user_name){
	ajaxObj = null;
 	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		//iDebug(">>>userLogin successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var res = eval('('+_xmlHttp.responseText+')');
		if(res.ret == 0){  //新建账号or登录成功进入				
			accessToken = res.access_token;	
		}else{
			accessToken = "TOKEN50001002";
		}
		checkData();
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {
		//iDebug(">>>userLogin failureCallback");
	};
	ajaxObj.url = addr + "/account/login?deviceno="+stbid+"&devicetype=2&accounttype=1&account="+user_id+"&pwd="+_pwd+"&accesstoken="+_token+"&isforce=1";
	//iDebug(">>>userLogin ajaxObj.url=" + ajaxObj.url);
	ajaxObj.requestData();
}

function init(){
	//$("denglcDiv").innerText = BrowserType + ":" + stbid;
	getParms();
	ajaxLoadMenuData();
}

function getParms(){
	var tempPos = mySessionStorage.getItem("monitorItemPos");
	if(typeof tempPos!="undefined" && tempPos!=null && tempPos!=""){
		itemPos = parseInt(tempPos,10);
	}
}


function ajaxLoadMenuData(){
	ajaxObj = null;
	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var jsonData = eval('(' + _xmlHttp.responseText + ')');
		if(typeof(jsonData) != "undefined" && jsonData.length > 0){
			menuData = jsonData;
			noDataFlag = false;
			getUserInfo();
		}
		// ajaxNavTitle();
		checkBackUrl();
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params){
		//iDebug(">>>ajaxLoadMenuData failureCallback");
		// ajaxNavTitle();
		checkBackUrl();
	};
	ajaxObj.url = dataAjaxPath;
	//iDebug(">>>ajaxLoadMenuData ajaxObj.url=" + ajaxObj.url);
	ajaxObj.requestData();
}

function ajaxNavTitle(){
	ajaxObj = null;
	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		//iDebug(">>>ajaxLoadMenuData successCallback _xmlHttp.responseText=" + _xmlHttp.responseText);
		var jsonData = eval('(' + _xmlHttp.responseText + ')');
		if(typeof(jsonData) != "undefined"){
			if(jsonData.navigator!=""){
				$("navTitle").innerText = jsonData.navigator;
				$("navTitle").style.left = (235+($("logoImage").width)+cellPadValue)+"px";
			}
		}else{}
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {};
	ajaxObj.url = navTitleAjaxPath;
	ajaxObj.requestData();
}


function checkBackUrl(){
	ajaxObj  = null;
	if (ajaxObj != null) {
		ajaxObj.requestAbort();
	}
	ajaxObj = new AjaxClass();
	ajaxObj.frame = window;
	ajaxObj.charset = "gbk";
	ajaxObj.successCallback = function(_xmlHttp, _params) {
		havaBackUrl = true;
	};
	ajaxObj.failureCallback = function(_xmlHttp, _params) {
		havaBackUrl = false;
		//iDebug(">>>ajaxLoadMenuData failureCallback");
	};
	ajaxObj.url = backUrl;
	//iDebug(">>>ajaxLoadMenuData ajaxObj.url=" + ajaxObj.url);
	ajaxObj.requestData();
}

function checkData(){
	//iDebug("checkData:noDataFlag=" + noDataFlag);
	if(noDataFlag){
		setTimeout(checkData,100);
	}else{
		if(BrowserType == "Inspur"){
			try {
				iSTB.player.set_video_window(330,118,869,487);
			} catch(E) {}
		}
		initItemMenu("first");
  		showFocus(); 
	}
}

function initItemMenu(_flag){
  	itemBox = new showList2D(pageNum,menuData.length,itemPos,200,window);
  	itemBox.focusObj = itemFocusArray;
	itemBox.isLoop   = true;
	itemBox.pageLoop = true;
  	itemBox.focusDiv = "itemFocusDiv";
  	itemBox.haveData = function(_list){
		$("title_"+_list.idPos).style.visibility = "visible";
		$("title_"+_list.idPos).innerText = menuData[_list.dataPos].title;
		if(getStrChineseLength(menuData[_list.dataPos].title)>5){
			$("title_"+_list.idPos).innerText = subStr(menuData[_list.dataPos].title,5);
		}
	};
  	itemBox.notData = function(_list){
		$("title_"+_list.idPos).style.visibility = "hidden";
		$("title_"+_list.idPos).innerText = "";
	};
  	itemBox.startShow(); 
  	scroll_bar = new ScrollBar("barDiv", null, window);
  	scroll_bar.init(menuData.length ,0, 414, 0);
  	scroll_bar.scroll(itemBox.position);
	if(typeof(_flag) != "undefined" && _flag == "first"){
		playMonitor();
	}
}

function showFocus(){
  	$("title_"+itemBox.currFocus).style.color = "#045d6b";
  	$("title_"+itemBox.currFocus).style.backgroundImage = "url(images/btn0_2.png)";
  	if(getStrChineseLength(menuData[itemBox.position].title)>6){
    	$("title_"+itemBox.currFocus).innerHTML = "<marquee style=\"width:200px;\">"+menuData[itemBox.position].title+"</marquee>";
  	}
}

function clearFocus(){
  	$("title_"+itemBox.currFocus).style.color = "#7a634d";
 	$("title_"+itemBox.currFocus).style.backgroundImage = "url(images/btn0_1.png)";
  	if(getStrChineseLength(menuData[itemBox.position].title)>5){
    	$("title_"+itemBox.currFocus).innerHTML = subStr(menuData[itemBox.position].title,5);
  	}
}

function changeUD(_num){
	if(focusArea == 0){
    clearFocus();
    itemBox.changeList(_num);
    showFocus();
    scroll_bar.scroll(itemBox.position);
		clearTimeout(playTimer);
		playTimer = setTimeout(playMonitor,500); 
	} 
}

function changeLR(_num){
	if(focusArea == 0 && _num > 0){
    	focusArea = 1;
		$("videoFocus").style.visibility = "visible";
		$("title_"+itemBox.currFocus).style.backgroundImage = "url(images/btn0_1.png)";
	}else if(focusArea == 1 && _num < 0){
		focusArea = 0;
		$("title_"+itemBox.currFocus).style.backgroundImage = "url(images/btn0_2.png)";
		$("videoFocus").style.visibility = "hidden";
	}
}

function doSelect(){
	if(focusArea == 1){//进入全屏播放
		mySessionStorage.setItem("monitorItemPos",itemBox.position);
		window.location.href = "content.htm?videoUrl=" + localVideoUrl+accessToken;
	}
}

//切换播放模式
function changePlayMode(){
	if(randomPlayStatus){
		randomPlayStatus = false;
		stopRandomPlay();
	}else{
		randomPlayStatus = true;
		startRandomPlay("first");
	}
}

var randomPlayTimer = -1;
function startRandomPlay(_flag){
	if(typeof(_flag) == "undefined"){//传参数表示刚启动（先不要重新播，等间隔时间到了再播），自动切换时不传参数
		var pos = Math.floor(Math.random() * menuData.length);//随机获取数组下标
		var newPlayUrl = menuData[pos].videoUrl;
		playMonitor(newPlayUrl);
		if(pos!= itemBox.position){  //如果获取的下标位置跟当前不一样，则刷新左侧列表
			itemPos = pos;
			initItemMenu();
		}	
	}
	clearTimeout(randomPlayTimer);
	randomPlayTimer = setTimeout(startRandomPlay,10*1000);//五分钟切换一次
}

function stopRandomPlay(){
	clearTimeout(randomPlayTimer);
}

function playMonitor(_playUrl){
	if(typeof(_playUrl) == "undefined"){
		var newPlayUrl = menuData[itemBox.position].videoUrl;
	}else{
		var newPlayUrl = _playUrl;
	}
	//如果现在和上次播放的是同一个监控则不处理，否则会收不到播放成功或失败的消息
  	if(localVideoUrl == newPlayUrl) return;
	stopMonitor();
  	localVideoUrl = newPlayUrl;
	if(BrowserType == "Inspur"){
		try {
			//iDebug(">>>zhaoql--aaa="+localVideoUrl);
			//$("denglcDiv").innerText += "|" + localVideoUrl + accessToken + "&playtoken=ABCDEFG";
			iSTB.player.play(localVideoUrl+accessToken+"&playtoken=ABCDEFG");
		} catch(E) {}
	}
}

function stopMonitor(){
	if(BrowserType == "Inspur"){
		try {
			//iDebug("stop Monitor");
			iSTB.player.stop();
		} catch(E) {}
	}
}

function doBack(){
	mySessionStorage.removeItem("monitorItemPos");
	if(havaBackUrl){
		window.location.href = backUrl;
	}else{
		goPortal();
	}
}

function exit(){
	stopMonitor();	
}

if(BrowserType == "Inspur"){
	try {
		iSTB.evt.set_event_callback("eventCallback");
	} catch(E) {}
}

function eventCallback(type,event_name,event_type,event_value){
  switch(event_name){
    case "LOAD_FINISHED":   //播放成功
      break;
    case "PLAYER_ERROR":    //播放失败
      break;
    case "PLAYER_BUFFERING_START":  //开始播放
      break;
    case "PLAYER_FINISH":
      break;
    case "PLAYER_BUFFERING_END":
      break;
  }
}

</script>
<body background="images/bg.png" leftmargin="0" topmargin="0" onload="init()" onunload="exit()">
<div style="position: absolute; left: 235px; top: 26px;">
	<img id="logoImage" src=""/>
</div>
<div style="position: absolute; left: 399px; width: 744px; height: 49px; top: 27px; line-height: 49px; font-size: 27px" id=""></div>

<div style="position: absolute; left: 167px; top: 602px; width: 22px; height: 19px;"><img src="images/down.png" width="22" height="19" /></div>
<div style="position: absolute; left: 167px; top: 106px; width: 22px; height: 19px;"><img src="images/up.png" width="22" height="19" /></div>

<!--左侧列表-->
<div id="title_0" style="position: absolute; left: 56px; top: 129px; width: 244px; height: 63px; background-image: url(images/btn0_1.png); font-size: 32px; color: #7a634d; line-height: 60px; text-align: center; visibility:hidden"></div>
<div id="title_1" style="position: absolute; left: 56px; top: 209px; width: 244px; height: 63px; background-image: url(images/btn0_1.png); font-size: 32px; color: #7a634d; line-height: 60px; text-align: center; visibility:hidden"></div>
<div id="title_2" style="position: absolute; left: 56px; top: 289px; width: 244px; height: 63px; background-image: url(images/btn0_1.png); font-size: 32px; color: #7a634d; line-height: 60px; text-align: center; visibility:hidden"></div>
<div id="title_3" style="position: absolute; left: 56px; top: 369px; width: 244px; height: 63px; background-image: url(images/btn0_1.png); font-size: 32px; color: #7a634d; line-height: 60px; text-align: center; visibility:hidden"></div>
<div id="title_4" style="position: absolute; left: 56px; top: 449px; width: 244px; height: 63px; background-image: url(images/btn0_1.png); font-size: 32px; color: #7a634d; line-height: 60px; text-align: center; visibility:hidden"></div>
<div id="title_5" style="position: absolute; left: 56px; top: 529px; width: 244px; height: 63px; background-image: url(images/btn0_1.png); font-size: 32px; color: #7a634d; line-height: 60px; text-align: center; visibility:hidden"></div>
<!--滚动条-->
<div style="position: absolute; left: 1227px; top: 120px; width: 10px; height: 482px; background-image: url(images/bar_bg.png);">
  <div id="barDiv" style="position:absolute; left:0px; top:0px; width:8px; height:68px;"><img src="images/bar.png" width="8" height="68" /></div>
</div>
<!--列表焦点-->
<div id="itemFocusDiv"></div>
<!--视频焦点-->
<div id="videoFocus" style="position: absolute; left: 292px; top: 81px; width: 924px; height: 544px; background: url(images/videoFocus.png) no-repeat; visibility:hidden;"></div>

<!--滚动字幕-->
<div style="position: absolute; left: 90px; top: 647px; width: 581px; height: 30px;">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <!--<td width="45"><img src="image/icon_notice.png" width="32" height="23" /></td>-->
        <td style="font-size:20px; color:#323232; line-height:30px; text-align:center">
         <!-- <marquee style="position: absolute; left: 40px; width: 630px; "  id="marqueeTd">按蓝键开启轮询功能,再次按键停止轮询功能。
          </marquee>--></td>
      </tr>
    </table>
  </div>
<!--<div style="position: absolute; width: 808px; height: 577px; left: 243px; top: 67px; word-wrap: break-word; word-break: normal; background-color: #F00; visibility: hidden" id="test"></div>-->
<!-- <div id="denglcDiv" style="position:absolute;width:700px;height:500px;left:120px;top:120px;font-size:24px;color:#fff;word-break:break-all;"></div> -->
</body>
</html>

