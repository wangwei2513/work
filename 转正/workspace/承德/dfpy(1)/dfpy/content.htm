<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>问卷内容</title>
<script type="text/javascript" src="js/config.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript">
window.onkeydown = function(e){
	var e = e || event;
	var keycode = e.keyCode || e.which || e.charCode;
	switch(keycode){
		case 1:
		case 38: 	//up
			if(tipFlag){return false;}
			changeUD(-1);
			return EVENT.STOP;
			break;
		case 2:
		case 40: 	//down
			if(tipFlag){return false;}
			changeUD(1);
			return EVENT.STOP;
			break;
		case 3:
		case 37: 	//left
			if(tipFlag){return false;}
			changeLR(-1);
			return EVENT.STOP;
			break;
		case 4:
		case 39: 	//right
			if(tipFlag){return false;}
			changeLR(1);
			return EVENT.STOP;
			break;
		case 13: 	//enter
			if(tipFlag){return false;}
			doSelect();
			return EVENT.STOP;
			break;
		case 8:
		case 340: 	//back
			window.location.href = "index.htm";
			return EVENT.STOP;
			break;
		case 27:
		case 339: 	//exit
			return EVENT.STOP;
			break;
	}
}
/**********************变量**********************/
var menuData = [];
var listPos = 0;
var subPos = 0;
var focusArea = 0;
var currPage = 1;
var totalPage = 1;
var pageSize = 3;
var maxLength = 4;

var ajaxObj = null;

var selectArr = [];
var ifCheck = false;	//当前选题的类型 false 单选 true 多选
var title = "";
var questionId = "";
var caid = "";
var tipTimer = null;
var tipFlag = false;
var count = 0;
var isExit = false;
/**********************方法**********************/
function init(){
	initParams();
	initTitle();
	ajaxQuestionData();
}

function initParams(){
	if(getUrlParams("id",window.location.href,"&")){
		questionId = parseInt(getUrlParams("id",window.location.href,"&"),10);
	}
	if(getUrlParams("name",window.location.href,"&")){
		title = decodeURI(getUrlParams("name",window.location.href,"&"));
	}
	caid = getCardId();
}

function initTitle(){
	title = title == "" ? "调查问卷" : title;
	$("title").innerText = getStrChineseLen(title,22);
}

function ajaxQuestionData(){
	if(ajaxObj == null){
		ajaxObj = new ajaxClass();
		ajaxObj.charset = "utf-8";
		ajaxObj.frame = window;
	}
	else{
		ajaxObj.requestAbort();
	}

	var url = Api.getQuestionContent;
	url = url.replace("{0}",questionId);
	ajaxObj.url = url;

	ajaxObj.successCallback = function(_xmlHttp){
		var getData = eval("("+_xmlHttp.responseText+")");
		menuData = getData.question_list;
		for(var i=0;i<menuData.length;i++){
			selectArr[i] = [];
		}
		initContent();
		onFocus();
	}

	ajaxObj.failureCallback = function(){
		initContent();
		onFocus();
	}

	ajaxObj.requestData();
}

function initContent(){
	clearContent();
	if(menuData.length > 0){
		totalPage = Math.ceil(menuData.length/pageSize);
		for(var i=0;i<Math.min(pageSize,menuData.length-(currPage-1)*pageSize);i++){
			$("question"+i).style.display = "block";
			$("name"+i).innerText = ((currPage-1)*pageSize+i+1) + "." + getStrChineseLen(menuData[i+(currPage-1)*pageSize].question_title,27);
			for(var j=0;j<menuData[i+(currPage-1)*pageSize].question_options.length;j++){
				if(selectArr[i+(currPage-1)*pageSize].indexOf(j) == -1){
					$("icon"+i+"_"+j).style.display = "inline-block";
					$("icon"+i+"_"+j).style.backgroundColor = "#fbc79d";
				}
				else{
					$("icon_bg"+i+"_"+j).style.display = "inline";
				}
				$("option"+i+"_"+j).innerText = getStrChineseLen(menuData[i+(currPage-1)*pageSize].question_options[j].option_content,14);
			}
		}
	}
	$("cur").innerText = currPage;
	$("total").innerText = totalPage;
}

function clearContent(){
	for(var i=0;i<pageSize;i++){
		for(var j=0;j<maxLength;j++){
			$("icon"+i+"_"+j).style.display = "none";
			$("icon"+i+"_"+j).style.backgroundColor = "#fbc79d";
			$("icon_bg"+i+"_"+j).style.display = "none";
			$("option"+i+"_"+j).innerText = "";
		}
		$("name"+i).innerText = "";
		$("question"+i).style.backgroundImage = "";
		$("question"+i).style.display = "none";
	}
}

function onFocus(){
	switch(focusArea){
		case 0:
			onContentFocus();
			onOptionFocus();
			break;
		case 1:
			onSubmitFocus();
			break;
		default:
			break;
	}
}

function onContentFocus(){
	$("question"+listPos).style.backgroundImage = "url(images/list_bg.png)";
	if(menuData.length > 0){
		ifCheck = menuData[listPos+(currPage-1)*pageSize].question_ifCheck;
		if(menuData[listPos+(currPage-1)*pageSize].question_title.length > 27){
			$("name"+listPos).innerHTML = "<marquee style=\"width:955px;\">"+((currPage-1)*pageSize+listPos+1)+"."+menuData[listPos+(currPage-1)*pageSize].question_title+"</marquee>";
		}
	}
}

function loseContentFocus(){
	$("question"+listPos).style.backgroundImage = "";
	if(menuData.length > 0){
		if(menuData[listPos+(currPage-1)*pageSize].question_title.length > 27){
			$("name"+listPos).innerText = ((currPage-1)*pageSize+listPos+1) + "." + getStrChineseLen(menuData[listPos+(currPage-1)*pageSize].question_title,27);
		}
	}
}

function onOptionFocus(){
	if(menuData.length <= 0){return false;}
	$("focus").style.display = "block";
	$("focus").width = "558";
	$("focus").height = "101";
	var r = Math.floor(subPos/(maxLength/2));
	var l = subPos%(maxLength/2);
	$("focus").style.left = 86 + l*517 + "px";
	$("focus").style.top = 129 + listPos*182 + r*62 + "px";
	if($("icon"+listPos+"_"+subPos).style.display == "inline-block"){
		$("icon"+listPos+"_"+subPos).style.backgroundColor = "#fff";
	}
	$("option"+listPos+"_"+subPos).style.color = "#fff";
	if(menuData[listPos+(currPage-1)*pageSize].question_options[subPos].option_content.length > 14){
		$("option"+listPos+"_"+subPos).innerHTML = "<marquee style=\"width:420px;\">"+menuData[listPos+(currPage-1)*pageSize].question_title+"</marquee>";
	}
}

function loseOptionFocus(){
	if($("icon"+listPos+"_"+subPos).style.display == "inline-block"){
		$("icon"+listPos+"_"+subPos).style.backgroundColor = "#fbc79d";
	}
	$("option"+listPos+"_"+subPos).style.color = "";
	if(menuData.length <= 0){return false;}
	if(menuData[listPos+(currPage-1)*pageSize].question_options[subPos].option_content.length > 14){
		$("option"+listPos+"_"+subPos).innerHTML = getStrChineseLen(menuData[listPos+(currPage-1)*pageSize].question_options[subPos].option_content,14);
	}
}

function onSubmitFocus(){
	$("focus").style.display = "block";
	$("focus").width = "160";
	$("focus").height = "80";
	$("focus").style.left = "1090px";
	$("focus").style.top = "633px";
}

function changeUD(_num){
	if(menuData.length <= 0){return false;}
	if(focusArea == 0){
		if(listPos == 0 && currPage == 1 && _num == -1){
			;
		}
		else{
			loseOptionFocus();
			loseContentFocus();
			subPos = 0;
			if(listPos+(currPage-1)*pageSize >= menuData.length - 1 && _num == 1){
				changeArea(1);
				return false;
			}
			else if((listPos == 0 && currPage > 1 && _num == -1) || (listPos == pageSize-1 && currPage < totalPage && _num == 1)){
				currPage += _num;
				initContent();
				listPos = _num == 1 ? 0 : pageSize-1;
			}
			else{
				listPos += _num;
			}
			onContentFocus();
			onOptionFocus();
		}

	}
	else if(focusArea == 1){
		if(_num == -1){
			changeArea(0);
		}
	}
}

function changeLR(_num){
	if(menuData.length <= 0){return false;}
	if(focusArea == 0){
		if(menuData[listPos+(currPage-1)*pageSize].question_options.length <= 0){return false;}
		loseOptionFocus();
		subPos += _num;
		subPos = subPos < 0 ? 0 : subPos;
		subPos = subPos >= menuData[listPos+(currPage-1)*pageSize].question_options.length ? menuData[listPos+(currPage-1)*pageSize].question_options.length - 1 : subPos;
		onOptionFocus();
	}
}

function changeArea(_num){
	focusArea = _num;
	onFocus();
}

function doSelect(){
	if(focusArea == 0){
		if($("icon"+listPos+"_"+subPos).style.display == "inline-block"){
			if(ifCheck){
				selectArr[listPos+(currPage-1)*pageSize].push(subPos);
			}
			else{
				selectArr[listPos+(currPage-1)*pageSize] = [subPos];
			}
			initContent();
		}
		else if($("icon_bg"+listPos+"_"+subPos).style.display == "inline"){
			if(ifCheck){
				var idx = selectArr[listPos+(currPage-1)*pageSize].indexOf(subPos);
				selectArr[listPos+(currPage-1)*pageSize].splice(idx,1);
			}
			else{
				selectArr[listPos+(currPage-1)*pageSize] = [];
			}
			initContent();
		}
		onOptionFocus();
	}
	else if(focusArea == 1){
		for(var i=0;i<selectArr.length;i++){
			if(selectArr[i].length <= 0){
				showTips("未完成问卷！");
				break;
			}
			if(i == selectArr.length - 1){
				count = 0;
				ajaxSubmitData(0);
			}
		}
	}
}

function ajaxSubmitData(i){
	if(i >= selectArr.length){return false;}
	if(ajaxObj == null){
		ajaxObj = new ajaxClass();
		ajaxObj.charset = "utf-8";
		ajaxObj.frame = window;
	}
	else{
		ajaxObj.requestAbort();
	}

	var type = menuData[i].question_ifCheck;
	var option = "";
	for(var j=0;j<selectArr[i].length;j++){
		if(type){
			option += menuData[i].question_options[selectArr[i][j]].option_id + ";";
		}
		else{
			option += menuData[i].question_options[selectArr[i][j]].option_id;
		}
	}
	var url = Api.submitRes;
	url = url.replace("{0}",caid).replace("{1}",questionId).replace("{2}",menuData[i].question_id).replace("{3}",option).replace("{4}",1);
	ajaxObj.url = url;
	//$("test").innerText += url+"|";

	ajaxObj.successCallback = function(_xmlHttp){
		var getData = eval("("+_xmlHttp.responseText+")");
	//	$("test").innerText += getData.result+"|";
		if(getData.result == 1){
			count++;
			if(i == selectArr.length - 1){
				isExit = true;
				if(count == selectArr.length){
					showTips("提交成功！");
				}
				else{
					showTips("提交成功"+count+"个！");
				}
			}
		}
		i++;
		ajaxSubmitData(i);
	}

	ajaxObj.failureCallback = function(){
		i++;
		ajaxSubmitData(i);
	}

	ajaxObj.requestData();
}

function showTips(_str){
	clearTimeout(tipTimer);
	tipFlag = true;
	$("tipCon").innerText = _str;
	$("tip").style.display = "block";
	tipTimer = setTimeout(function(){
		$("tipCon").innerText = "";
		$("tip").style.display = "none";
		tipFlag = false;
		if(isExit){
			window.location.href = "index.htm";
			isExit = false;
		}
	},1000);
}

function getCardId(){
	try{
		if(typeof(CAManager)!="undefined"){
			return CAManager.cardSerialNumber;
		}else if(typeof(CA)!="undefined"){
			return CA.serialNumber || CA.card.serialNumber;
		}else{
			return iSTB.settings.get("sys:ca0:cardnumber") || "";
		}
	}
	catch(e){}
}
</script>
</head>
<body background="images/bg1.jpg" topmargin="0" leftmargin="0" onload="init()">
<!-- title -->
<div id="title" style="position:absolute;width:1205px;height:80px;line-height:80px;padding-top:15px;left:38px;top:0px;font-size:44px;font-weight:bold;color:#fffa00;text-align:center;"></div>
<!-- focus -->
<img id="focus" src="images/focus1.png" width="558" height="101" style="display:none;position:absolute;left:86px;top:129px;">
<!-- content -->
<div id="question0" style="position:absolute;width:1205px;height:182px;left:38px;top:96px;">
	<div id="name0" style="position:absolute;width:1033px;height:32px;line-height:32px;left:86px;top:9px;font-size:34px;color:#501103;"></div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:86px;top:50px;">
		<div id="icon0_0" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg0_0" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option0_0" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:603px;top:50px;">
		<div id="icon0_1" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg0_1" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option0_1" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:86px;top:112px;">
		<div id="icon0_2" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg0_2" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option0_2" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:603px;top:112px;">
		<div id="icon0_3" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg0_3" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option0_3" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
</div>
<div id="question1" style="position:absolute;width:1205px;height:182px;left:38px;top:278px;">
	<div id="name1" style="position:absolute;width:1033px;height:32px;line-height:32px;left:86px;top:9px;font-size:34px;color:#501103;"></div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:86px;top:50px;">
		<div id="icon1_0" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg1_0" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option1_0" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:603px;top:50px;">
		<div id="icon1_1" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg1_1" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option1_1" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:86px;top:112px;">
		<div id="icon1_2" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg1_2" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option1_2" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:603px;top:112px;">
		<div id="icon1_3" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg1_3" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option1_3" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
</div>
<div id="question2" style="position:absolute;width:1205px;height:182px;left:38px;top:460px;">
	<div id="name2" style="position:absolute;width:1033px;height:32px;line-height:32px;left:86px;top:9px;font-size:34px;color:#501103;"></div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:86px;top:50px;">
		<div id="icon2_0" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg2_0" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option2_0" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:603px;top:50px;">
		<div id="icon2_1" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg2_1" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option2_1" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:86px;top:112px;">
		<div id="icon2_2" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg2_2" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option2_2" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
	<div style="position:absolute;width:516px;height:62px;line-height:62px;left:603px;top:112px;">
		<div id="icon2_3" style="display:none;width:26px;height:26px;font-size:0px;background-color:#fbc79d;border:1px solid #50180c;margin-top:17px;vertical-align:top;"></div>
		<img id="icon_bg2_3" src="images/icon_1.png" width="55" height="60" style="display:none;margin-top:1px;">
		<div id="option2_3" style="display:inline-block;font-size:30px;vertical-align:top;"></div>
	</div>
</div>
<!-- page -->
<div style="position:absolute;width:300px;height:39px;line-height:39px;left:38px;top:646px;font-size:26px;color:#a2541c;text-align:left;"><span id="cur" style="color:#8e4511;font-size:34px;"></span>/<span id="total"></span></div>
<!-- icon -->
<table cellpadding="0" cellspacing="0" border="0" style="position:absolute;width:440px;height:53px;left:801px;;top:646px;font-size:20px;color:#faf9f6;">
	<tr>
		<td width="13%"><img src="images/btn_4.png" width="47" height="47"></td>
		<td width="23%">选择题目</td>
		<td width="12%"><img src="images/btn_5.png" width="47" height="47"></td>
		<td width="22%">选择选项</td>
		<td width="11%"><img src="images/btn_6.png" width="47" height="47"></td>
		<td width="19%">确认提交</td>
	</tr>
</table>
<div id="tip" style="display:none;position:absolute;width:520px;height:304px;left:380px;top:120px;background-image:url(images/tip.png);">
	<div style="position:absolute;width:500px;height:42px;line-height:42px;left:10px;top:0px;font-size:32px;color:#fff;text-align:center;">温馨提示</div>
	<div id="tipCon" style="position:absolute;width:400px;height:96px;line-height:32px;left:60px;top:120px;word-break:break-all;overflow:hidden;font-size:30px;color:#fff;text-align:center;"></div>
</div>

<!--<div id="test" style="position:absolute;width:800px;left:240px;top:100px;height:400px;word-break:break-all;font-size:30px;"></div>*-->
</body>
</html>