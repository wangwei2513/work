<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>16</title>
    <style>
        .circal {
            width: 30px;
            height: 30px;
            border-radius: 30px;
            border: 1px solid #000;
            position: absolute;
            top: 10px;
            right: 0;
            background: #ffa400;
            display: block;
            line-height: 30px;
            text-align: center;
            visibility: hidden;
            color: #000;
        }
    </style>
</head>

<body background="cover.png" leftmargin="0" topmargin="0">
    <div style="position:absolute;left:308px;top:119px; width:664px;height:422px;background:#fff;overflow:hidden;">
        <div style="position:absolute;left:0px;top:0px;width:664px;height:50px;background:#dd302c;z-index:3">
            <div id="desc" style="position:absolute;left:25px;top:0px; line-height:50px; font-size:24px;color:#fff;">优秀党员评比</div>
            <div style="position:absolute;right:25px;top:0px; line-height:50px; font-size:24px;color:#fff;">
                <span id="currQuestion">1</span>
                <span>/</span>
                <span id="totleQuestion">2</span>
            </div>
        </div>

        <div style="position:absolute;left:0px;top:50px; width:664px; height:50px;font-size:24px; color:#999;line-height:53px;">
            <div style="position:absolute;left:0px;top:53px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:0px;top:106px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:0px;top:159px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:0px;top:211px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:0px;top:264px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:0px;top:317px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:0px;top:370px; width:664px; height:1px; background:#f2f1e8;z-index: 3"></div>
            <div style="position:absolute;left:25px;top:0px; width:624px; height:53px; ">
                <div id="question0" style="position:absolute;left:0;top:0px; width:624px;background:#fff;  "></div>
            </div>
            <!-- <div id="question1" style="position:absolute;left:25px;top:53px; width:624px; height:53px; ">1.能按时完成党内工作任务？</div> -->
            <!-- <div id="question2" style="position:absolute;left:25px;top:106px; width:624px; height:53px; ">1.能按时完成党内工作任务？</div> -->
            <div style="position:absolute;left:25px;top:159px;width:624px;height:53px;"><span id="answer0"></span><span id="a0" class="circal">√</span></div>
            <div style="position:absolute;left:25px;top:212px;width:624px;height:53px;"><span id="answer1"></span><span id="a1" class="circal">√</span></div>
            <div style="position:absolute;left:25px;top:265px;width:624px;height:53px;"><span id="answer2"></span><span id="a2" class="circal">√</span></div>

            <!--按钮-->
            <div id="submit" style="position:absolute;left:0px;top:318px;width:332px;height:53px; line-height:55px; text-align:center; font-size:26px; color:#000; border-right:1px solid #e5e5e5;">上一题</div>
            <div id="cancel" style="position:absolute;left:333px;top:318px;width:332px;height:53px; line-height:55px; text-align:center; font-size:px; color:#000;">下一题</div>
        </div>
        <div style="position:absolute;left:165px;top:117px;width:332px;height:255px;background: #ccc;z-index: 4;display: none;">
            <div style="position: absolute;left: 0;top:0;width: 332px;height: 50px;line-height: 50px;text-align: center;font-size: 22px;">温馨提示</div>
            <div id="message" style="position: absolute;left: 0;top:50px;width: 332px;height: 205px;line-height: 28px;text-align: center;font-size: 22px;">aaaaaaaaa</div>
        </div>
        <div id="navBar" style="position: absolute;z-index: 3; left: 650px; top: 50px; width: 14px; height: 73px; background: url(page_bar1.png);"></div>
    </div>
    <script type="text/javascript" src="js/ajaxClass.js"></script>
    <script type="text/javascript" src="js/comm.js"></script>
    <script type="text/javascript" src="js/keyevent.js"></script>
    <script type="text/javascript" src="js/global.js"></script>
    <!--<script type="text/javascript" src="Noname1.js"></script>-->
    <script>
        var localUrl = "http://192.168.101.30:9876/votesManager_guangan/getAreaByCardId?cardId=12343"
        var questionnaireIdUrl = "http://192.168.101.30:9876/votesManager_guangan/getAreaByCardId?cardId=12343"
        var queryAll = "http://192.168.101.30:9876/votesManager_guangan/getQuestionnaires.action?questionnaireId=0";
        var voteUrl = "http://192.168.101.30:9876/votesManager_guangan/addVote.action";
        var voteInfoUrl = "http://192.168.101.30:9876/votesManager_guangan/getVoteOptionIds.action";
        var queryArea = "http://192.168.101.30:9876/votesManager_guangan/getAllArea.action"; //
        var AllQuestOptionUrl = "http://192.168.101.30:9876/votesManager_guangan/getAllQuestionsAndOptions.action?questionnaireId="; //
        var resultUrl = "http://192.168.101.30:9876/votesManager_guangan/getScore.action?caId=11111&questionnaireId="
        var listData = [];
        var answerData = [];
        var resultData = [];
        var pos = 0;
        var CASerialNumber = '11111';
        var currPage = 0;
        var totlePage = 0;
        var selected = 0;
        var ajaxObj = null;
        var quesPos = 0;
        var areaId = '';
        var messageFlag = false;
        var navBarSpeed = 0;
        var faliureData = [];
        var focusArea = 0;
        var secTimeData = [];
        var seccessData = [];
        var questionPage = 0;
        var speed = 0;
        var totleLen = 0;
        var currQues = 0;
        // document.onkeydown = eventHandler;

        function eventHandler(eventObj) {
            var e = e || event;
            var keycode = e.keyCode || e.which || e.charCode;
            // /var eventObj = Event.mapping(keycode);
            switch (eventObj.code) {
                case 1:
                case 38: //up
                    keyUp()
                    return false;
                    break;
                case 2:
                case 40: //down
                    keyDown();
                    return false;
                    break;
                case 3:
                case 37: //left
                    keyLeft();
                    return false;
                    break;
                case 4:
                case 39: //right
                    keyRight();
                    return false;
                    break;
                case 13:
                    doSelect();
                    return false;
                    break;
                case 8:
                    goBack();
                    return false;
                    break;
                case 513: //menu
                    exitWidget();
                    break;
                case 512: //homepage
                    goBack();
                    return false;
                    break;
                default:
                    break;
            }


        };



        function clearFocus() {

        }

        function keyUp() {
            if (focusArea == 0) {
                if ($("question0").offsetTop < 0) {
                    if (currQues <= questionPage - 1 && currQues > 1) {
                        currQues--;
                        $("question0").style.top = $("question0").offsetTop + 159 + "px"
                    } else {
                        currQues--;
                        $("question0").style.top = "0px"
                    }
                }
            } else {
                var optionLen = listData[quesPos].question_options.length
                if (!messageFlag) {
                    if (optionLen == 4) {
                        if (pos < 5 && pos > 0) {
                            pos--;

                        } else if (pos == 5) {
                            pos -= 2
                        } else if (pos == 0) {
                            focusArea = 0;
                            focusMove();
                        }
                        focusMove();
                    } else {
                        if (pos < optionLen && pos > 0) {
                            pos--;
                        } else if (pos == 4 || pos == 5) {
                            pos = optionLen - 1;
                        } else if (pos == 0) {
                            focusArea = 0;
                            focusMove();
                        }
                        focusMove();
                    }

                }
            }

        }


        function keyDown() {
            totleLen = $("question0").offsetHeight;
            questionPage = Math.ceil($("question0").offsetHeight / 159);
            // speed = 

            if (focusArea == 0) {
                if ($("question0").offsetHeight > 159) {
                    if (questionPage > 2 && currQues < questionPage - 1) {
                        currQues++
                        $("question0").style.top = -(currQues * 159) + "px"
                    } else if (questionPage > 2 && currQues == questionPage - 1) {
                        $("question0").style.top = -(totleLen - 159) + "px"
                    } else if (questionPage == 2 && currQues < 1) {
                        currQues++
                        $("question0").style.top = -(totleLen - 159) + "px"
                    } else if ($("question0").offsetTop == (159 - totleLen)) {
                        focusArea = 1;
                        focusMove();
                    }
                } else {
                    focusArea = 1;
                    focusMove();

                }

            } else {
                if (!messageFlag) {
                    var optionLen = listData[quesPos].question_options.length
                    if (optionLen == 4) {
                        if (pos < 4) {
                            pos++;
                            focusMove();
                        }
                    } else {
                        if (pos < optionLen - 1) {
                            pos++;
                            focusMove();
                        } else if (pos == optionLen - 1) {
                            pos = 4;
                            focusMove();
                        }
                    }
                }
            }

        }

        function keyLeft() {
            if (!messageFlag) {
                if (pos == 4) {
                    pos = 5;

                } else if (pos == 5) {
                    pos = 4;

                }
                focusMove();
            }

        }

        function keyRight() {
            if (!messageFlag) {
                if (pos == 4) {
                    pos = 5;

                } else if (pos == 5) {
                    pos = 4;

                }
                focusMove();
            }
        }


        function focusMove() {
            empty();
            if (focusArea == 0) {
                $("question0").style.background = "ffa400";

            } else {
                if (pos < 4) {
                    $("answer" + pos).parentNode.style.background = "#ffa400";
                } else if (pos == 4) {
                    $("submit").style.background = "#ffa400";

                } else {
                    $("cancel").style.background = "#ffa400";

                }
            }

        }


        function empty() {
            // $("question0").style.background = "#fff";
            for (var j = 0; j < 3; j++) {
                $("answer" + j).parentNode.style.background = "#fff";

            }

            $("submit").style.background = "#fff";

            $("cancel").style.background = "#fff";

        }

        function init() {
            // focusMove();
            getAll();

        }

        function getLocalCode() {
            var ajaxObj = new ajaxClass();
            ajaxObj.url = localUrl;
            // ajaxObj.url = "node.js"
            ajaxObj.charset = "utf-8";
            ajaxObj.successCallback = function(_xmlHttp) {
                var str = _xmlHttp.responseText;
                var data = eval("(" + str + ")");
                areaId = data.areaid;
                getAllQuestOption(Wenjuan[0].id);
                // getAllQuestOption(questionnaireId);
            };
            ajaxObj.failureCallback = function(_xmlHttp) {

            };
            ajaxObj.requestData();
        }
        var Wenjuan = [];

        function getAll() {
            var ajaxObj = new ajaxClass();
            ajaxObj.url = queryAll;
            // ajaxObj.url = "node.js"
            ajaxObj.charset = "utf-8";
            ajaxObj.successCallback = function(_xmlHttp) {
                var str = _xmlHttp.responseText;
                Wenjuan = eval("(" + str + ")");

                $("desc").innerText = Wenjuan[0].name;
                getAllQuestOption(Wenjuan[0].id);
                // getAllQuestOption(questionnaireId);
            };
            ajaxObj.failureCallback = function(_xmlHttp) {

            };
            ajaxObj.requestData();
        }

        function getTestResult() {
            var ajaxObj = new ajaxClass();
            ajaxObj.url = resultUrl + Wenjuan[0].id;
            ajaxObj.charset = "utf-8";
            ajaxObj.successCallback = function(_xmlHttp) {
                var str = _xmlHttp.responseText;
                resultData = eval("(" + str + ")");
                showText("您的分数为" + resultData.score)
                    // $("message").innerText = resultData.score;

                // getAllQuestOption(questionnaireId);
            };
            ajaxObj.failureCallback = function(_xmlHttp) {

            };
            ajaxObj.requestData();
        }


        function getAllQuestOption(_id) {
            var ajaxObj = new ajaxClass();
            ajaxObj.url = AllQuestOptionUrl + _id;
            // ajaxObj.url = "content.js";
            ajaxObj.charset = "utf-8";
            ajaxObj.successCallback = function(_xmlHttp) {

                var str = _xmlHttp.responseText;
                var list = eval("(" + str + ")");
                listData = list.question_list;
                $("totleQuestion").innerText = listData.length;
                for (var i = 0; i < listData.length; i++) {
                    var obj = {
                        questionId: listData[i].question_id,
                        optionId: [],
                        pos: pos,
                        selected: false
                    }
                    answerData.push(obj)
                }
                totlePage = Math.ceil(listData.length / 3);
                navBarSpeed = Math.ceil(282 / listData.length);
                ////("getAllQuestOption.length:"+listData.length);
                initList();

            };
            ajaxObj.failureCallback = function(_xmlHttp) {
                //("ajax请求失败");
            };
            ajaxObj.requestData();
        }

        function navBarMove(num) {
            $("navBar").style.top = $("navBar").offsetTop + num * navBarSpeed + "px";
        }

        function initList() {
            emptyList();
            if (quesPos == listData.length - 1) {
                $("cancel").innerText = "提交";
            } else {
                $("cancel").innerText = "下一题";
            }
            $("currQuestion").innerText = quesPos + 1;

            var queTitle = listData[quesPos].question_title;

            $("question0").innerText = listData[quesPos].question_title;
            $("question0").style.background = "ffa400"

            var contentLength = listData[quesPos].question_options.length;
            for (var j = 0; j < contentLength; j++) {
                $("answer" + j).innerText = listData[quesPos].question_options[j].option_content;
            }
            focusMove()
            if (answerData[quesPos].selected) {
                $("answer" + pos).style.color = "#000";
                $("a" + pos).style.visibility = "visible";
                $("answer" + pos).parentNode.style.background = "#ffa400";

            }

        }

        function emptyList() {
            $("question0").style.top = "0"
            if (answerData[quesPos].selected) {
                focusArea = 1;

            } else {
                focusArea = 0;
            }

            currQues = 0;
            $("question0").innerText = "";
            for (var j = 0; j < 3; j++) {
                $("answer" + j).innerText = "";
                $("answer" + j).style.boxShadow = '';
            }
        }
        // 去除答案数组的重复选项
        function array_contain(array, obj) {
            for (var i = 0; i < array.length; i++) {
                if (array[i] === obj) //如果要求数据类型也一致，这里可使用恒等号===
                    return true;
            }
            return false;
        }
        // 确认
        function doConfirm() {
            if (listData[quesPos].question_ifCheck) {
                if (pos < 4 && focusArea == 1) {
                    answerData[quesPos].questionId = listData[quesPos].question_id;
                    answerData[quesPos].pos = pos;
                    answerData[quesPos].selected = true;
                    if (array_contain(answerData[quesPos].optionId, pos)) {
                        // answerData[quesPos].optionId.push(pos);
                    } else {
                        answerData[quesPos].optionId.push(listData[quesPos].question_options[pos].option_id);
                    }
                    answerFocus();
                }
            } else {
                if (pos < 4 && focusArea == 1) {
                    answerData[quesPos].questionId = listData[quesPos].question_id;
                    answerData[quesPos].pos = pos;
                    answerData[quesPos].selected = true;

                    answerData[quesPos].optionId[0] = listData[quesPos].question_options[pos].option_id;
                    answerFocus();
                }

            }
        }
        // 确定
        function doSelect() {
            if (!messageFlag) {
                if (quesPos == listData.length - 1) {
                    if (pos == 5) {
                        secTimeData = [];
                        for (var i in answerData) {
                            var a = i;
                            console.log(a)
                            var selectedOption = '';
                            if (listData[a].question_ifCheck) {

                                selectedOption = '';
                                for (var j = 0; j < answerData[a].optionId.length; j++) {
                                    selectedOption += answerData[a].optionId[j] + ";"

                                }

                            } else {
                                selectedOption = answerData[a].optionId[0]
                            }
                            console.log(selectedOption)
                            if (selectedOption !== undefined) {
                                var ajaxObj = new ajaxClass();
                                ajaxObj.url = voteUrl + "?caId=" + CASerialNumber + "&questionnaireId=" + Wenjuan[0].id + "&questionId=" + answerData[i].questionId + "&optionId=" + selectedOption + "&operatorKey=1";
                                ajaxObj.successCallback = function(_xmlHttp) {
                                    var str = _xmlHttp.responseText;
                                    var data = eval("(" + str + ")");
                                    if (data.result == 1) { //成功 
                                        seccessData.push(answerData[a].questionId)
                                    } else if (data.result == 0) {
                                        faliureData.push(answerData[a].questionId)
                                    } else if (data.result == 2) {
                                        secTimeData.push(answerData[a].questionId)
                                    }
                                    if (i == listData.length - 1) {
                                        console.log(i)
                                        if (seccessData.length == listData.length) {
                                            // showText("提交成功")
                                            getTestResult();
                                            messageFlag = true;
                                        } else if (secTimeData.length == listData.length) {
                                            // showText("所有题目都已提交，请勿重复提交")
                                            getTestResult();
                                            messageFlag = true;
                                        } else if (faliureData.length > 0) {
                                            worn();
                                            messageFlag = true;
                                        }
                                        console.log(2222)
                                    }
                                };
                                ajaxObj.failureCallback = function(_xmlHttp) {

                                };
                                ajaxObj.requestData();

                            } else {
                                showText("请完成所有题目")
                                messageFlag = true
                            }

                        }

                    } else if (pos == 4 && quesPos != 0 && focusArea == 1) {
                        quesPos--;
                        initList();

                        if (answerData[quesPos].selected) {
                            pos = answerData[quesPos].pos
                            console.log(1)
                        } else {
                            pos = 0;
                            console.log(0)
                        }
                        emptyAnswer();
                        initList();

                        navBarMove(-1);
                    } else {
                        doConfirm();
                    }
                } else {
                    if (pos == 5) {
                        quesPos++;
                        initList();
                        if (answerData[quesPos].selected) {
                            pos = answerData[quesPos].pos
                        } else {
                            pos = 0;
                        }
                        emptyAnswer();
                        initList();

                        navBarMove(1);
                    } else if (pos == 4 && quesPos != 0) {
                        quesPos--;
                        if (answerData[quesPos].selected) {
                            pos = answerData[quesPos].pos
                        } else {
                            pos = 0;
                        }
                        emptyAnswer();
                        initList();
                        navBarMove(-1);
                    } else {
                        doConfirm();
                    }
                }


            } else {
                $("message").parentNode.style.display = "none";
                messageFlag = false;
            }
        }
        // 返回
        function goBack() {
            top.hidePop();
            // window.history.go(-1)
        }
        // 提示框内容
        function worn() {
            var str = "";
            for (var i = 0; i < faliureData.length - 1; i++) {
                str += faliureData[i] + "、";
            }
            str += faliureData[faliureData.length - 1]
            $("message").parentNode.style.display = "block";
            $("message").innerText = "第" + str + "题提交失败，请重新提交"
            setTimeout(function() {
                $("message").parentNode.style.display = "none";
                // faliureData = [];
            }, 6000)
        }
        // 提示框内容
        function showText(str) {
            $("message").parentNode.style.display = "block";
            $("message").innerText = str;
            setTimeout(function() {
                $("message").parentNode.style.display = "none";
            }, 6000)
        }
        // 选项焦点
        function answerFocus() {
            if (listData[quesPos].question_ifCheck) {
                if (pos < 4) {
                    $("answer" + pos).style.color = '#000';
                    $("a" + pos).style.visibility = "visible";
                }
            } else {
                if (pos < 4) {
                    emptyAnswer();
                    $("answer" + pos).style.color = '#000';
                    $("a" + pos).style.visibility = "visible";
                }
            }
        }
        // 清楚选项
        function emptyAnswer() {
            for (var i = 0; i < 3; i++) {
                $("answer" + i).style.color = '#aaa';
                $("a" + i).style.visibility = "hidden";
            }
        }
        window.onload = init();
    </script>



</body>

</html>