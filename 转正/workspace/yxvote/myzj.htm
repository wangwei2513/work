<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="page-view-size" content="1280*720">
<title>民意征集</title>
<script type="text/javascript" src="js/ajaxClass.js"></script>
<script type="text/javascript" src="js/comm.js"></script>
<script>
var queryAll = "http://localhost:8080/votesManager/getAllQuestionsAndOptions.action";
var voteUrl = "http://localhost:8080/votesManager/addVote.action";
var voteInfoUrl = "http://localhost:8080/votesManager/getVoteOptionIds.action";
//测试地址
queryAll = "http://192.168.47.51/zhsq/zhsq_app/prop/yxvote/data/queryAll.js";
voteUrl = "http://192.168.47.51/zhsq/zhsq_app/prop/yxvote/data/vote.js";
voteInfoUrl = "http://192.168.47.51/zhsq/zhsq_app/prop/yxvote/voteInfo.js";
var CA = {serialNumber:001};


var listData = [];
var areaFlag = 0;//0选项 1按钮
var chosePos = 0;//选项下标
var btnPos = 1;//按钮下标
var quesPos = 0;//第几题
var totalVotes = 0;//总共投了几个
document.onkeydown = grabEvent;
document.onsystemevent = grabEvent;

function grabEvent(){
	var eventObj = Event.mapping(event);
	var keycode = eventObj.code;
    if(keycode == "KEY_EXIT" || keycode == "KEY_MENU") {
        window.location.href = returnUrl;
    	
		return EVENT.STOP;
    }
	switch(keycode){
		case "KEY_UP": //up
			keyUp();
			return EVENT.STOP;
			break;
		case "KEY_DOWN": //down
			keyDown();
			return EVENT.STOP;
			break;
		case "KEY_LEFT": //left
			keyLeft();
			return EVENT.STOP;
			break;
		case "KEY_RIGHT": //right
			keyRight();
			return EVENT.STOP;
			break;
		case "KEY_SELECT":
			doSelect();
			return EVENT.STOP;
			break;
		case "KEY_BACK":
			window.location.href = "index.htm?1";
			return EVENT.STOP;
			break;
	}
}
function doSelect(){
	if(areaFlag==0){
		//投票
		var ajaxObj = new ajaxClass();
		ajaxObj.url = voteUrl + "?caId="+CA.serialNumber+"&questionId="+listData[quesPos].question_id+"&optionId="+listData[quesPos].question_options[chosePos].option_id+"&operatorKey=1";;
		ajaxObj.successCallback = function(_xmlHttp){
			var str = _xmlHttp.responseText;
			var data = eval("("+str+")");
			if(data.result==1){//成功
				showTxt("");
				totalVotes +=1;
				listData[quesPos].isChosed = true;//已投票
				listData[quesPos].chosednumber = listData[quesPos].question_options[chosePos].option_id;//记录投票的选项
				areaFlag = 1;
				btnPos = 1;
				initList();
				getFocus();
				if(totalVotes==listData.length){//全部投完了，弹出结果页面
					setTimeout(function (){
						window.location.href = "result.htm?1";
					},2000);
				}
			}else if(data.result==0){
				//alert("失败");	
				showTxt("投票失败");
			}else if(data.result==2){
				showTxt("之前已经投过票了");
				totalVotes +=1;
				listData[quesPos].isChosed = true;
				getVoteInfo();//--获取选过的选项
			}
		};
		ajaxObj.failureCallback = function(_xmlHttp){
		
		};
		ajaxObj.requestData();
	}else if(areaFlag==1){
		showTxt("");
		if(btnPos==0){
			if(quesPos>0){
				quesPos -=1;
				initList();
			}
		}else{
			if(quesPos<listData.length-1){
				quesPos +=1;
				initList();
			}	
		}
	}
}
//获取之前投票过的是哪些
function getVoteInfo(){
	var ajaxObj = new ajaxClass();
   	ajaxObj.url = voteInfoUrl+"?caId="+CA.serialNumber+"&questionId="+listData[quesPos].question_id;
	ajaxObj.successCallback = function(_xmlHttp){
        var str = _xmlHttp.responseText;
        var list = eval("("+str+")");
		var voteIds = list.option_ids;
		voteIds = parseInt(voteIds.split(";")[0]);//获取第一个选中的
		listData[quesPos].chosednumber = voteIds;//之前选中的选项
		areaFlag = 1;
		btnPos = 1;
		initList();
		getFocus();
		if(totalVotes==listData.length){//全部投完了，弹出结果页面
			setTimeout(function (){
				window.location.href = "result.htm?1";
			},2000);
		}
		
    };
    ajaxObj.failureCallback = function(_xmlHttp){
    
    };
    ajaxObj.requestData();	
}
function showTxt(_str){
	$("txt").innerText = _str;
}
function keyUp(){
	if(areaFlag==0){
		changeList(-1);	
	}else{
		if(listData[quesPos].isChosed){
			return ;	
		}
		blurFocus();
		areaFlag = 0;
		chosePos = listData[quesPos].question_options.length-1;
		getFocus();
	}
}
function keyDown(){
	if(areaFlag==0){
		changeList(1);	
	}else if(areaFlag==1){
		return;	
	}
}
function keyLeft(){
	if(areaFlag==0){
		return ;	
	}else if(areaFlag==1){
		changeBtn(-1);
	}	
}
function keyRight(){
	if(areaFlag==0){
		return ;	
	}else if(areaFlag==1){
		changeBtn(1);
	}	
}
function changeList(_num){
	if(chosePos+_num<0) return ;
	blurFocus();
	if(chosePos+_num>=listData[quesPos].question_options.length){
		areaFlag = 1;	
	}else{
		chosePos+=_num;	
	}
	getFocus();
}
function changeBtn(_num){
	blurFocus();
	btnPos = (btnPos+_num+2)%2;
	getFocus();
}

function init(){
	getAllQuestion();
}
function getAllQuestion(){
	var ajaxObj = new ajaxClass();
   	ajaxObj.url = queryAll;
	ajaxObj.successCallback = function(_xmlHttp){
        var str = _xmlHttp.responseText;
        var list = eval("("+str+")");
		listData = list.question_list;
		initList();
		getFocus();
    };
    ajaxObj.failureCallback = function(_xmlHttp){
    
    };
    ajaxObj.requestData();	
}
function initList(){
	for(var i=0;i<4;i++){
		if(listData[quesPos].question_options[i]){
			$("div"+i).style.visibility = "visible";
		}else{
			$("div"+i).style.visibility = "hidden";
		}	
	}
	if(listData[quesPos].question_ifCheck){
		$("question").innerText = listData[quesPos].question_title+"(多选)";
	}else{
		$("question").innerText = listData[quesPos].question_title+"(单选)";	
	}
	
	$("nums").innerText = (quesPos+1) +"/"+listData.length;
	if(listData[quesPos].isChosed){
		for(var i=0;i<listData[quesPos].question_options.length;i++){
			$("ans"+i).innerText = listData[quesPos].question_options[i].option_content;
			$("vote"+i).innerText = listData[quesPos].question_options[i].option_count;
			if(listData[quesPos].question_options[i].option_id ==listData[quesPos].chosednumber){
				$("done"+i).style.backgroundImage = "url(images/border_05.png)";
				$("done"+i).innerText = "已投";
				$("done"+i).style.color = "#000000";
			}else{
				$("done"+i).style.backgroundImage = "url(images/border_04.png)";
				$("done"+i).innerText = "投票";
				$("done"+i).style.color = "#FFFFFF";
			}
		}
	}else{
		for(var i=0;i<listData[quesPos].question_options.length;i++){
			$("ans"+i).innerText = listData[quesPos].question_options[i].option_content;
			$("vote"+i).innerText = listData[quesPos].question_options[i].option_count;
			$("done"+i).style.backgroundImage = "url(images/border_07.png)";
			$("done"+i).innerText = "投票";
			$("done"+i).style.color = "#FFFFFF";
			
		}
	}
}
function getFocus(){
	if(areaFlag==0){
		$("done"+chosePos).style.backgroundImage = "url(images/border_06.png)";
		$("done"+chosePos).style.color = "#000000";
	}else if(areaFlag==1){
		$("btn"+btnPos).style.backgroundImage = "url(images/border_02.png)";	
		$("btn"+btnPos).style.color = "#000000";	
	}
}
function blurFocus(){
	if(areaFlag==0){
		$("done"+chosePos).style.backgroundImage = "url(images/border_07.png)";
		$("done"+chosePos).style.color = "#FFFFFF";
	}else if(areaFlag==1){
		$("btn"+btnPos).style.backgroundImage = "url(images/border_03.png)";
		$("btn"+btnPos).style.color = "#FFFFFF";	
	}
}
</script>
</head>
<body style="background:url(images/bg.jpg) no-repeat;" onload="init()">	
	<!--title-->
	<div style="position:absolute;left:46px;top:29px;"><img src="images/logo.png"/></div>
	<div style="position:absolute;left:267px;top:52px;"><img src='images/icon.png'/></div>
	<div style="position:absolute;left:281px;top:52px;color:#d3d3d3;font-size:24px;">阳泉>全民投票>民意征集</div>
	<!-- 左侧信息-->
	<div style="position:absolute;left:46px;top:112px;background:url(images/border_01.png);width:910px;height:510px;">
		<div style="position:absolute;left:141px;top:27px;color:#ffffff;font-size:30px;">欢迎参加宜兴市争创全国文明城市的问卷调查</div>
		<img src="images/line_01.png" style="position:absolute;left:0px;top:68px;"  width="910" height="1"/>
		<div id="question" style="position:absolute;left:24px;top:91px;color:#ffffff;font-size:24px;"></div>
		<!--选项环节-->
		<div style="position:absolute;left:54px;top:149px;width:801px;height:261px;color:#ffffff;font-size:24px;">
			<table borde="0" cellpadding="0" cellspacing="0" style="position:absolute;left:0px;top:0px;" width="801" height="261">
				<tr>
					<td>
						<div id="div0" style="position:absolute;left:0px;top:0px;width:801px;height:72px;">
							<span id="ans0" style="position:absolute;left:9px;top:10px;"></span>
							<img id="icon0" src="images/icon_03.png" style="position:absolute;left:629px;top:13px;"/>
							<span id="vote0" style="position:absolute;left:650px;top:8px;font-size:22px;"></span>
							<div id="done0" style="position:absolute;left:723px;top:0px;background:url(images/border_07.png);width:78px;height:41px;font-size:22px;text-align:center;line-height:40px;">
								投票
							</div>
							<img src="images/line_01.png" style="position:absolute;left:9px;top:58px;"/>
						</div>
					</td>
					<td>
						<div id="div1" style="position:absolute;left:0px;top:72px;width:801px;height:72px;">
							<span id="ans1" style="position:absolute;left:9px;top:10px;"></span>
							<img id="icon1" src="images/icon_03.png" style="position:absolute;left:629px;top:13px;"/>
							<span id="vote1" style="position:absolute;left:650px;top:8px;font-size:22px;"></span>
							<div id="done1" style="position:absolute;left:723px;top:0px;background:url(images/border_07.png);width:78px;height:41px;font-size:22px;color:#ffffff;text-align:center;line-height:40px;">
								投票
							</div>
							<img src="images/line_01.png" style="position:absolute;left:9px;top:58px;"/>
						</div>
					</td>
					<td>
						<div id="div2" style="position:absolute;left:0px;top:144px;width:801px;height:72px;">
							<span id="ans2" style="position:absolute;left:9px;top:10px;"></span>
							<img id="icon2" src="images/icon_03.png" style="position:absolute;left:629px;top:13px;"/>
							<span id="vote2" style="position:absolute;left:650px;top:8px;font-size:22px;"></span>
							<div id="done2" style="position:absolute;left:723px;top:0px;background:url(images/border_07.png);width:78px;height:41px;font-size:22px;text-align:center;line-height:40px;">
								投票
							</div>
							<img src="images/line_01.png" style="position:absolute;left:9px;top:58px;"/>
						</div>
					</td>
					<td>
						<div id="div3" style="position:absolute;left:0px;top:216px;width:801px;height:72px;">
							<span id="ans3" style="position:absolute;left:9px;top:10px;"></span>
							<img id="icon3" src="images/icon_03.png" style="position:absolute;left:629px;top:13px;"/>
							<span id="vote3" style="position:absolute;left:650px;top:8px;font-size:22px;"></span>
							<div id="done3" style="position:absolute;left:723px;top:0px;background:url(images/border_07.png);width:78px;height:41px;font-size:22px;
								text-align:center;line-height:40px;">
								投票
							</div>
						</div>
					</td>
				</tr>
			</table>
		</div>
		<!--页码信息-->
		<div id="txt" style="position: absolute; text-align:right; font-size:20px; left: 654px; top: 416px; width:200px; height:20px; color: #ff0000;"></div>
        <div id="nums" style="position:absolute;left:529px;top:456px;color:#ffffff;font-size:24px;">2/9</div>
		<div id="btn0" style="position:absolute;left:582px;top:446px;background:url(images/border_03.png);width:132px;height:42px;text-align:center;color:#fff;font-size:24px;
			line-height:40px;">上一题
		</div>
		<div id="btn1" style="position:absolute;left:724px;top:446px;background:url(images/border_03.png);width:132px;height:42px;text-align:center;color:#fff;font-size:24px;
			line-height:40px;">下一题
		</div>
	</div>
	<!--右侧信息-->
	<div style="position:absolute;left:966px;top:111px;"><img src="images/pic_09.png"/></div>
	<!--底部信息-->
	<div style="position:absolute;left:51px;top:654px;"><img src='images/icon_02.png'/></div>
	<div style="position:absolute;left:97px;top:653px;color:#d3d3d3;font-size:22px;">明天宜兴会有大到小雨请相关部门做好....</div>
	<div style="position:absolute;left:1021px;top:653px;color:#d3d3d3;font-size:22px;">服务热线：12345</div>
</body>
</html>
