<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>无标题文档</title>
<script type="text/javascript" src="js/global.js"></script>
<script type="text/javascript" src="js/showList.js"></script>
<script type="text/javascript">
var topicId = window.location.search.split("?")[1].split("&")[0].split("=")[1];
console.log()
var menuArr = null;
var submitPos = 0;
var cancelPos = 0;
var menuStatus = [];
var pageMax = 8;
var pupShow = -1;
var pupShowFlag = false;
var menuBox = null;
var scrollObj = null;
var listAjaxObj = null;
var submitAjaxObj = null;
var btnArr = [{focus:"images-02/sure1.png",blur:"images-02/sure0.png"},{focus:"images-02/cancel1.png",blur:"images-02/cancel0.png"}];
var menuStatusPic = ["images-02/checkbox0.png","images-02/checkbox3.png"];
var cardId = tmpAgent == "chrome"?"12345678":CA.icNo;
var basicUrl = "http://172.18.254.197:8080/";
			
function eventHandler(Obj, type){
	switch(Obj.code) {
		case "KEY_UP":
			if(submitTipShow || pupShowFlag){
				changeBtn(-1);
			}else{
				changeUD(-1);
			}
			break;
		case "KEY_DOWN":
			if(submitTipShow || pupShowFlag){
				changeBtn(1);
			}else{
				changeUD(1);
			}
			break;
		case "KEY_LEFT":
			changeBtn(-1);
			break;	
		case "KEY_RIGHT":
			changeBtn(1);
			break;
		case "KEY_SELECT":
			doSelect();
			break;
		case "KEY_PAGE_UP":
			changePage(-1)
			break;
		case "KEY_PAGE_DOWN":
			changePage(1);
			break;
		case "KEY_EXIT":
		case "KEY_BACK":
		case "KEY_HOMEPAGE":
			window.location.href = "wjdc_list.htm?position="+pos;
			event.returnValue = false;
			return 0;
			break;
		case "KEY_GREEN"://绿键提交
			if(!submitTipShow){
				showSubmitTip();
			}else{
				hideSubmitTip();	
			}
			break;
		case "KEY_NUMERIC":
			if(Obj.args.value == 0){
				if(!submitTipShow){
					showSubmitTip();
				}else{
					hideSubmitTip();	
				}
			}
		break;
		default:
			break;
	}
}


function changeBtn(_num){
	if (submitTipShow) {
		$("btn"+submitPos).src = btnArr[submitPos].blur;
		submitPos = (submitPos + _num + 2)%2;	
		$("btn"+submitPos).src = btnArr[submitPos].focus;
	}else if (pupShowFlag) {
		$("pupBtn"+cancelPos).src = btnArr[cancelPos].blur;
		cancelPos = (cancelPos + _num + 2)%2;	
		$("pupBtn"+cancelPos).src = btnArr[cancelPos].focus;
	}
}

var submitTipShow = false;
function showSubmitTip(){
	submitTipShow = true;
	$("tipDiv").style.visibility = "visible";
}

function hideSubmitTip(){
	submitTipShow = false;
	$("tipDiv").style.visibility = "hidden";
}

function doSubmit(){
	if(submitAjaxObj == null){
		submitAjaxObj = new ajaxClass();
		//测试去掉注释
		//submitAjaxObj.charset = "gbk";
	} 
	else{
		submitAjaxObj.requestAbort();
	}
	var tmpOptionList = menuArr.questions[0].optionList;
	//问题ID+_+用户选择选项IDS，如果多题，则用英文逗号隔开，如果多个选项，选择之间用@符号连接
	//data=1_2@3,2_1@3@4,3_4
	var curr_questionId = menuArr.questions[0].questionId;
	var optionIdArr = [];
	for(var i = 0; i < menuStatus.length; i++){
		if(menuStatus[i] == 1){
			optionIdArr.push(tmpOptionList[i].optionId);	
		}	
	}
	var optionIdStr = optionIdArr.join("@");
	var data = curr_questionId + "_" +optionIdStr;
	submitAjaxObj.url = "data/submitData.js";
	//submitAjaxObj.url = basicUrl + "VoteSys_foshan/submitQuestion?topicId="+topicId+"&caid="+cardId+"&data="+data;
	if (optionIdArr.length == menuArr.questions[0].optionList.length) {
		showPup(1,"正在提交问卷...",false,false);
		submitAjaxObj.successCallback = function(_xmlHttp){
			var tmp = eval('('+_xmlHttp.responseText+')');
			if(tmp != null){
				if(tmp.code == 0){
					showPup(1,"提交成功...",true,false);
					
				}else{
					showPup(1,tmp.mes,true,false);
				}
				setTimeout(function(){ 

					window.location.href = "wjdc_list.htm?position="+pos
				},2000);
			}
		};
		submitAjaxObj.failureCallback = function(_xmlHttp){
			showPup(1,"提交失败...",true,false);
			setTimeout(function(){
				window.location.href = "wjdc_list.htm?position="+pos;
			},2000);
		}
		submitAjaxObj.requestData();	
	}else {
		showPup(1,"请完成所有的题目...",true,false);
	}
	
}

function doSelect(){
	if(submitTipShow){
		if(submitPos == 0){
			doSubmit();	
		}
		hideSubmitTip();	
	}else if (pupShowFlag) {
		if(cancelPos == 0){
			hidePup();
		}else if (cancelPos == 1){
			window.location.href = "wjdc_list.htm?position="+pos;
		}
	}else{
		var imgStatus = menuStatus[menuBox.position];
		if(imgStatus == 0){
			$("menuPic"+menuBox.focusPos).src = menuStatusPic[1];	
			menuStatus[menuBox.position] = 1;
		}else{
			$("menuPic"+menuBox.focusPos).src = menuStatusPic[0];
			menuStatus[menuBox.position] = 0;	
		}
	}
}

function changePage(_num){
	stopMarquee();
	menuBox.changePage(_num);
	if(scrollObj) scrollObj.scroll(menuBox.position);
	startMarquee();
}

function changeUD(_num){
	stopMarquee();
	menuBox.changeList(_num);
	if(scrollObj) scrollObj.scroll(menuBox.position);
	startMarquee();
}

function init(){
	getParms();
	showTime();	
	clearMenu();
	getData();
}

var pos = 0;
function getParms(){
	var tempPos = RequestUrl(window.location.href,"position");
	if(tempPos!=""){
		pos = parseInt(tempPos,10);
	}
}

function showTime(){
	var weekArr = ["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];
	var d = new Date();
	var year = d.getFullYear().toString();
	var month = (d.getMonth() + 1).toString();
	var day = d.getDate().toString();
	var week = weekArr[d.getDay()];
	var hour = d.getHours().toString();
	var minute = d.getMinutes().toString();
	var second = d.getSeconds().toString();
	if(month.length < 2) month = "0" + month; 
	if(day.length < 2) day = "0" + day; 
	if(hour.length < 2) hour = "0" + hour; 
	if(minute.length < 2) minute = "0" + minute; 
	if(second.length < 2) second = "0" + second; 
	
	$("weekDiv").innerText = week;
	$("dateDiv").innerText = year + "." + month + "." + day;
	$("timeDiv").innerText = hour + ":" + minute +":" + second;
	setTimeout("showTime();",1000);
}

function initMenuStatus(){
	menuStatus = [];
	var tmpOptionList = menuArr.questions[0].optionList;
	for(var i = 0; i<tmpOptionList.length; i++){
		menuStatus.push(0);
	}
}

function clearMenu(){
	for(var i = 0; i<8; i++){
		$("menuPic"+i).src = "images-02/blank.png";
		$("menuText"+i).innerText = "";
	}	
}

function getData(){
	if(listAjaxObj == null){
		listAjaxObj = new ajaxClass();
		//测试去掉注释
		//listAjaxObj.charset = "gbk";
	} 
	else{
		listAjaxObj.requestAbort();
	}
	listAjaxObj.url = "data/voteContent2_"+topicId+".js";
	//listAjaxObj.url = basicUrl + "VoteSys_foshan/getData?topicId="+topicId+"&caid="+cardId;

	// showPup(1,"正在请求列表数据...",false,false);
	listAjaxObj.successCallback = function(_xmlHttp){
		var tmp = eval("("+_xmlHttp.responseText+")");
		if(tmp != null){
			hidePup();
			//alert("tmp.code = "+tmp.code+" tmp.data.isFinished = "+tmp.data.isFinished);
			if(tmp.code == 0 && !tmp.data.isFinished){//只有code为0时，data才有值；isFinished为0，表示未完成，获取到的数据才是投票问题列表，反正是投票结果的数据
				
				menuArr = tmp.data;
				showData();
			}else if(tmp.code == 0 && tmp.data.isFinished){
				showPup(1,"您已投过票了！",false,false);
			}else{
				showPup(1,"请求到的列表为空",false,false);	
			}
		}
		else{
			showPup(1,"请求到的列表为空",false,false);
		}
	};
	listAjaxObj.failureCallback = function(_xmlHttp){
		showPup(1,"请求列表数据失败",false,false);
	}
	listAjaxObj.requestData();
}

function showData(){
	initMenuStatus();
	if(getStrChineseLength(menuArr.questions[0].questionContent) > 30){
		$("menuTitle").innerText = menuArr.questions[0].questionContent.substring(0,30)+"..";
	}else{
		$("menuTitle").innerText = menuArr.questions[0].questionContent;	
	}
	var tmpOptionList = menuArr.questions[0].optionList;
	menuBox = new showList1(pageMax, tmpOptionList.length, 0, 118, window);
	menuBox.focusDiv = "focus";
	menuBox.listHigh = 66;
	menuBox.focusLoop = true;
	menuBox.pageLoop = true;
	menuBox.haveData = function(List){
		$("menuPic"+List.idPos).src = menuStatusPic[menuStatus[List.dataPos]];
		var tempTxt = tmpOptionList[List.dataPos].optionContent;
		if(getStrChineseLength(tempTxt) > 40){
			$("menuText"+List.idPos).innerHTML = tempTxt.substring(0,40) + "..";
		}else{
			$("menuText"+List.idPos).innerHTML = tempTxt;	
		}
	};
	menuBox.notData = function(List){
		$("menuPic"+List.idPos).src = "images-02/blank.png";
		$("menuText"+List.idPos).innerText = "";
	};
	menuBox.startShow();
	startMarquee();
	
	scrollObj = new ScrollBar("slider", null, window);
	scrollObj.init(tmpOptionList.length, pageMax, 532, -3, 1);
	scrollObj.scroll(menuBox.position);	
}

function startMarquee(){
	var tempTxt = menuArr.questions[0].optionList[menuBox.position].optionContent;
	if(getStrChineseLength(tempTxt) > 40){
		$("menuText"+menuBox.focusPos).innerHTML = "<marquee behavior='scroll' width='980' startposition='10%'>" + tempTxt + "</marquee>";		
	}
}

function stopMarquee(){
	var tempTxt = menuArr.questions[0].optionList[menuBox.position].optionContent;
	if(getStrChineseLength(tempTxt) > 40){
		$("menuText"+menuBox.focusPos).innerHTML = tempTxt.substring(0,40) + "..";
	}
}

/*显示弹出框，flag:0,弹出框需要交互  1::弹出框不需要交互 2:有一个交互按钮的弹出框*/ 
var pupTimeout = -1;
var pupShow = -1;
function showPup(_flag,_text,_autoHide,_backFlag){
	pupShow = _flag;
	pupShowFlag = true;
	$("msg").innerText = _text;
	$("pupBox").style.visibility = "visible";
	clearTimeout(pupTimeout);
	if(_autoHide){
		pupTimeout = setTimeout(function(){
			hidePup();
		},7000);
	}
}

function hidePup(){
	pupShow = -1;
	pupShowFlag = false;
	$("pupBox").style.visibility = "hidden";
	$("msg").innerText = "";
}

</script>
</head>

<body background="images-02/insidepages_bg.jpg" leftmargin="0" topmargin="0" onload="init()">
<div style="position:absolute;left:170px;top:25px;color:#fff;font-size:36px;">
		在线调查
	</div>

<!--标题日期-->
<!-- <div style="position:absolute; left:75px; top:33px; width:196px; height:44px;"><img src="images-02/title2.png" width="196" height="44" /></div> -->
<div style="position:absolute; left:967px; top:32px; width:240px; height:50px;">
  <table width="100%" height="100%" border="0" cellspacing="0" cellpadding="0" style=" font-size:18px;color:#FFFFFF; ">
    <tr>
      <td align="right"><span id="weekDiv" style="font-size:20px;"></span><br /><span id="dateDiv" style="font-size:20px;"></span></td>
      <td width="20" align="center"><img src="images-02/topline0.png" width="2" height="36" /></td>
      <td id="timeDiv" width="110" style="font-size:42px;"></td>
    </tr>
  </table>
</div>

<!--分割线-->
  <div style="position:absolute; left:71px; top:80px; width:1142px; height:585px; background-image:url(images-02/item_bg.png);"></div>


<!--内容-->
<div style="position:absolute; left:75px; top:75px; width:1130px; height:585px;">
  <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-size:26px; color:#FFFFFF; line-height:66px;">
    <tr>
      <td id="menuTitle" height="60" colspan="2" align="center" style="font-size:38px; color:#FFFFFF; line-height:60px;"></td>
    </tr>
    <tr>
      <td width="55"><img id="menuPic0" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText0">&nbsp;</td>
    </tr>
    <tr>
      <td><img id="menuPic1" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText1">&nbsp;</td>
    </tr>
    <tr>
      <td><img id="menuPic2" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText2">&nbsp;</td>
    </tr>
    <tr>
      <td><img id="menuPic3" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText3">&nbsp;</td>
    </tr>
    <tr>
      <td><img id="menuPic4" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText4"><br /></td>
    </tr>
    <tr>
      <td><img id="menuPic5" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText5">&nbsp;</td>
    </tr>
    <tr>
      <td><img id="menuPic6" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText6">&nbsp;</td>
    </tr>
    <tr>
      <td><img id="menuPic7" src="images-02/checkbox0.png" width="44" height="40" /></td>
      <td id="menuText7">&nbsp;</td>
    </tr>
  </table>
</div>

<div id="focus" style="position:absolute; left:58px; top:118px; width:1178px; height:102px; background:url(images-02/FocusImg4.png) no-repeat center;"></div>

<!--滑动条-->
<div style="position:absolute; left:1221px; top:128px; width:10px; height:532px; background:url(images-02/sliderBgImg1.png) no-repeat;">
  <div id="slider" style="position:absolute; left:0px; top:-3px; width:10px; height:100px;">
    <table width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="10" height="10" style="background:url(images-02/sliderBarImg1.png);"></td>
      </tr>
      <tr>
        <td style="background:url(images-02/sliderBarImg2.png) repeat-y;"></td>
      </tr>
      <tr>
        <td height="10" style="background:url(images-02/sliderBarImg3.png);"></td>
      </tr>
    </table>
  </div>
</div>

<!--操作提示-->
<div style="position:absolute; left:788px; top:668px; width:435px; height:32px;">
  <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-size:18px; color:#666666; line-height:32px;">
    <tr>
      <td width="60"><img src="images-02/tips_green.png" width="54" height="26" /></td>
      <td width="65">提交</td>
      <td width="60"><img src="images-02/tips_prev.png" width="54" height="26" /></td>
      <td width="60"><img src="images-02/tips_next.png" width="54" height="26" /></td>
      <td width="75">翻页</td>
      <td width="60"><img src="images-02/tips_return.png" width="54" height="26" /></td>
      <td>返回</td>
    </tr>
  </table>
</div>

<!--弹出框-->
<div id="tipDiv" style="position:absolute;top:195px;left:409px;width:462px; height:330px;background-image:url(images-02/alertImg.png); visibility:hidden;">
 <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-size:28px; position:absolute; top:116px; left:25px; color:#FFFFFF; line-height:85px; width: 406px;">
    <tr>
      <td colspan="2" align="center">您要提交此问卷吗？</td>
    </tr>
	<tr>
      <td colspan="2" height="20px"></td>
    </tr>
    <tr align="center">
      <td><img id="btn0" src="images-02/sure1.png" width="150" height="47"/></td>
      <td><img id="btn1" src="images-02/cancel0.png" width="150" height="47"/></td>
    </tr>
  </table>
</div>

<div id="pupBox" style="position:absolute;top:195px;left:409px;width:462px; height:330px;background-image:url(images-02/alertImg.png); visibility:hidden;">
 <table width="100%" border="0" cellspacing="0" cellpadding="0" style="font-size:28px; position:absolute; top:116px; left:25px; color:#FFFFFF; line-height:85px; width: 406px;">
    <tr>
      <td id="msg" colspan="2" align="center"></td>
    </tr>
	<tr>
      <td colspan="2" height="20px"></td>
    </tr>
    <tr align="center">
      <td><img id="pupBtn0" src="images-02/sure1.png" width="150" height="47"/></td>
      <td><img id="pupBtn1" src="images-02/cancel0.png" width="150" height="47"/></td>
    </tr>
  </table>
</div>
</body>
</html>
